--
-- pwa/p2js.exw
-- ============
--
--  Phix Web Application / Phix to JavaScript transpiler.
--
--  Develop on desktop, publish to the web.
--
--  NOTE: The structure of the Parse Tree is ad-hoc/slap-dash and subject to change...
--
--with js
--with javascript_semantics
--
-- TODO (prioritised):
--  About -> Written in [[http://phix.x10.mx|Phix]]
--bugger: iff needs to short-circuit... [NAH, DONE]
--                      let /*string*/ t4 = iff(i+3<=lt,text[i..i+3],"");
-- ah:                  let /*string*/ t4 = (i+3<=lt) ? text[i..i+3] : "";
-- (and we'll have to parse that as well...)
-- (and that text[] needs to be .slice, so we need scope-with-type as well...) [DONE in a different way]
--  output some js! [DONE]
--  Have a copy option that does mediawiki: every line must start with spaces and eg    [DONE, ctrl M]
--      <span style="color: #CC0000;">IupMainLoop</span>
--   --> now, where was I doing that before???
--   -- I /think/ I was using tools/htmlise eucode and then manually adding leading spaces.
--   Or, instead of copy option/pop-up, use say Ctrl M (Mediawiki) or Ctrl D (meDiawiki) or Ctrl K (mediawiKi).
--  make a start on the options pop-up. (then the copy pop-up [ie original/mediawiki/output(html/js/...)])
--  menu, list, tree.
--  scope: [easily removable] links in the ttree.... all the basics from p2js.js and pGUI.e pre-loaded...   [DONE]
--         [presumably addScope() and dropScope()...]
--  get the basic parser working...
--    *** STOP TRYING TO PRESERVE COMMENTS! *** (mid-statement/expression ones anyway,      [OK, panic over!]
--                                               block = {statement|comment} is easy.)
--      The phix => js => phix test is that it still works, not character-perfect!!!
--  get some basic precedence handling in there, to match rosetta\Compiler\parse.exw
--      (see also C:\Program Files (x86)\Phix\demo\rosetta\Compiler\Verify_Syntax.exw)
--      2+3*4 is 2 + (3 x 4) = 14, not (2 + 3) x 4 = 20.
--      2*3+4 is (2 x 3) + 4 = 10, not 2 x (3 + 4) = 14.
--      a-b+c is (a-b)+2 not a-(b+c).
--      Note to self: when emitting nested expressions, parenths are needed if left/right is an operator with a <= precedence,
--          eg {*,{+,3,4},5} is (3+4)*5, not 3+4*5, whereas
--             {+,{*,3,4},5} is 3*4+5, not (3*4)+5.
--  parse test\t66prec.exw (if...) [DONE]
--  add a basic letter-only ternary tree... (p2js_ttree.e, charwise, no take-backs) [DONE]
--  make a reactive sample, with resize_cb setting HIDEHEADERS depending on width.
--  make a menu sample, see also C:\Program Files (x86)\Phix\pwa\phix\budget\budget.exw (plus includes)
--  sort out the final directory structure, add to phix7zip.lst, etc. [DONE]
--  (tabs/)toggle-able panes: source [scrollable with cross-hairs], tokens, ast, output... 
--  start on the GUI (run itself in browser, albeit with fixed samples and cut/paste/copy only, no direct file i/o.)
--                   (also: no result pane on the desktop, and the run button does something quite different...)
--                   [options] Minimise: X off, X css, X css+js, X all. Split lines : 0+/- (max 132 or 512?)
--                             Phix metalink: X (<meta Written in Phix - http://phix.x10.mx />
--                                                  <meta name="generator" content="FrontPage 4.0">
--  revisit plade.exw: (only) deal with working samples/controls, get it going in the browser...
--  minifier: create/test pGUI.min.js and pGUI.min.css (and pwa.min.html?)
--  reindenter: exw -> AST, twiddle a few numbers on the AST, AST -> exw, maybe...
--  include file handling/treeview of source files [desktop only]
--  (put in a special check to prohibit overwriting of pwa.exw, pGUI.js, and friends...??)
--  make meta tags automatically self-closing
--  just write down what you want, eg
--      integer i[;]        ==>  {T_integer, tdx[integer], tdx[i] [, tdx[;]]}                   (where tdx[i] can be a list of vars)
--      /* integer */ i;    ==>  {T_integer, tdx[/*integer*/], tdx[i], tdx[;]}
--      integer i = 0;      ==>  {T_integer, tdx[integer], {tdx[i], tdx[=], tdx[0]}, tdx[;]}    (where tdx[0] can be a nested sub-expression)
--      procedure ...       ==>  {T_procedure, tdx[procedure], tdx[name], tdx[(], {tdx[arg]}, tdx[)], {tdx[body]}, tdx[end], tdx[procedure]}
--                                 [ ^^^ or INCLUDE/VARIABLE/etc as defined below ]
--  one line at a time!  ==> all the way to the GUI!
--  proper error handling: {T_error, ...[msg/line/col/snippet]} in[stead of] ast, as display-able as anything else!
--      (where practical, it could try to carry on parsing, as long as first error stays first & is immediately visible)
--  console.log(1/2); (phew!)
-- Review file:///E:/downloads/misc/js/vanillajs/winbox-master/index.html
--

--/*
-- other things to avoid... (5/5/21)
add
addEventListener
alignItems
appendChild
Array
atan
background
bottom
BRANCHOPEN_CB
charCodeAt
children
classList
className
clientHeight
clientWidth
clientX
clientY
contains
createElement
createElementNS
currentTarget
Date
disconnect
display
documentElement
Error
fill
firstChild
firstElementChild
forEach
fromCharCode
getAttribute
getBoundingClientRect
getComputedStyle
getDate
getDay
getElementsByClassName
getFullYear
getHours
getMilliseconds
getMinutes
getMonth
getSeconds
hasChildNodes
hasOwnProperty
height
id
indexOf
innerHTML
innerHeight
innerText
innerWidth
insertAdjacentHTML
IntersectionObserver
isArray
isFinite
isInteger
isIntersecting
isSafeInteger
justifyContent
key
lastElementChild
lastIndexOf
left
localeCompare
map
margin
marginBottom
marginLeft
marginRight
marginTop
Math
maxWidth
minimumHeight
minimumWidth
name
nextElementSibling
nextSibling
now
Number
observe
offsetHeight
offsetLeft
offsetTop
offsetWidth
onclick
ondblclick
ondragstart
onkeydown
onmousedown
pageX
pageY
parentNode
parseFloat
parseInt
pow
preventDefault
previousElementSibling
push
querySelector
querySelectorAll
RegExp
removeAttribute
removeChild
removeEventListener
right
scrollTop
setAttribute
setTimeout
slice
String
style
substr
substring
TABTIITLE
target
textAlign
textContent
title
toExponential
toFixed
toLowerCase
toPrecision
toString
toUpperCase
toggle
top
unshift
valueOf
washeight
wasleft
wastop
waswidth
width
window
xm
ym
zIndex

--DEV taken back out:
    {"key",                         BADT,   T_key                           := 9212},
    {"name",                        BADT,   T_name                          := 9936},
    {"add",                         BADT,   T_add                           := 1460},
    {"pow",                         BADT,   T_pow                           := 10856},
    {"left",                        BADT,   T_left                          := 9368},
    {"target",                      BADT,   T_target                        := 13824},
    {"xm",                          TYPF,   T_xm                            := 15244},
    {"ym",                          TYPF,   T_ym                            := 15440},
    {"double",                      BADT,   T_double                        := 16376},
    {"right",                       TYPF,   T_right                         := 11948},
    {"height",                      BADT,   T_height                        := 6148},
    {"width",                       BADT,   T_width                         := 15100},
    {"id",                          BADT,   T_id                            := 6136},
    {"children",                    BADT,   T_children                      := 2748},
    {"fill",                        BADT,   T_fill                          := 16436},
    {"title",                       BADT,   T_title                         := 14164},
    {"byte",                        BADT,   T_byte                          := 15680},

just in case:
pwa\builtins\bsearch.js
pwa\builtins\dict.js
pwa\builtins\factorial.js
pwa\builtins\find.js
pwa\builtins\gcd.js
pwa\builtins\log10.js
pwa\builtins\match.js
pwa\builtins\misc.js
pwa\builtins\pcase.js
pwa\builtins\pcolumn.js
pwa\builtins\pdates.js
pwa\builtins\pelapsed.js
pwa\builtins\pextract.js
pwa\builtins\pfactors.js
pwa\builtins\pfindall.js
pwa\builtins\pfindany.js
pwa\builtins\pflatten.js
pwa\builtins\pmaths.js
pwa\builtins\ppp.js
pwa\builtins\primes.js
pwa\builtins\pseqc.js
pwa\builtins\psplit.js
pwa\builtins\psqop.js
pwa\builtins\psum.js
pwa\builtins\ptagset.js
pwa\builtins\ptrim.js
pwa\builtins\punique.js
pwa\builtins\scanf.js
pwa\builtins\sort.js
pwa\builtins\substitute.js
pwa\builtins\utfconv.js

--*/

--/*
constant limz = {1,1,8,9,18,64} -- found by experiment
 
procedure untouchable(integer n, cols=0, tens=0)
    atom t0 = time(), t1 = t0+1
    bool tell = n>0
    n = abs(n)
    sequence sums = repeat(0,n+3)
    for i=1 to n do
        integer p = get_prime(i)
        if p>n then exit end if
        sums[p+1] = 1
        sums[p+3] = 1
    end for
    sums[5] = 0
 
    integer m = floor(log10(n))
    integer lim = limz[m]*n
    for j=2 to lim do
        integer y = sum(factors(j,-1))
        if y<=n then
            sums[y] = 1
        end if
        if platform()!=JS and time()>t1 then
            progress("j:%,d/%,d (%3.2f%%)\r",{j,lim,(j/lim)*100})
            t1 = time()+1
        end if
    end for
    if platform()!=JS then progress("") end if
    if tell then
        printf(1,"The list of all untouchable numbers <= %d:\n",{n})
    end if
    string line = "       2       5"
    integer cnt = 2
    for t=6 to n by 2 do
        if sums[t]=0 then
            cnt += 1
            if tell then
                line &= sprintf("%,8d",t)
                if remainder(cnt,cols)=0 then
                    printf(1,"%s\n",line)
                    line = ""
                end if
            end if
        end if
    end for
    if tell then
        if line!="" then
            printf(1,"%s\n",line)
        end if
        printf(1,"\n")
    end if
    t0 = time()-t0
--  string t = iff(t0>1?elapsed(t0,fmt:=" (%s)"),"")
    string t = iff(t0>1?elapsed(t0,0," (%s)"),"")
    printf(1,"%,20d untouchable numbers were found <= %,d%s\n",{cnt,n,t})
    for p=1 to tens do
        untouchable(-power(10,p))
    end for
end procedure
 
untouchable(2000, 10, 6-(platform()==JS))
--*/

--  Hmm. This works but is probably going down the wrong path:
--      for (let i=length(res); i>=1; i-=1) {
--  //      let /*integer*/ ch = res[i-1];
--          let /*integer*/ ch = res.charAt(i-1);
--          if ((ch==='0') || (ch==='.')) {
--  //          res[i] = ' ';
--              res = res.substr(0,i-1).concat(' ').concat(res.substr(i));
--          }
--          if (ch!='0') { break; }
--      }
--  Oh my, those '0' and '.' are wrong uns 'n all....
--  Time to review those opcodes I put in: 
    -- opRepe is n (noofsubscripts), ref, rep, idx1..idxn           -- ref[idx1][idx2]~[idxn] := rep
--erm...
    -- opRepe is n (noofsubscripts), rep, idxn..idx1, ref
--  jdesc[opRepe] = "opRepe,N,rep,idxN..idx1,ref\n"
    --
    -- opReps is n (noofsubscripts), ref, idx1..n, sliceend, rep    -- ref[idx1]~[idxn..sliceend] := rep
    --
--  jdesc[opReps] = "opReps,N,ref,sliceend,idxN..idx1,dest\n"
    --
    -- opSubse is N, ref, idx1..idxN, res                           -- res := ref[idx1][idx2]~[idxN]
    --
--  jdesc[opSubse] = "opSubse,N,dest,idxN..idx1,ref\n"
    --
    -- opSubss is N, ref, idx1..idxN, sliceend, res                 -- res := ref[idx1]~[idxN..sliceend]
    --
--  jdesc[opSubss] = "opSubss,N,dest,sliceend,idxN..idx1,ref\n"
    --
    -- opConcatN is N, res, ref1..refN                              -- res := ref1&ref2..&refN
    --
--  opConcatN = 26,
--  jdesc[opConcat] = "opConcat,dest,a,b\n"
--  jdesc[opConcatN] = "opConcatN,N,ref1..refN,res\n"
--
without debug                   -- (keep ex.err clean)
include builtins\timedate.e
include builtins\pdates.e
include builtins\pdate.e
include builtins\VM\pprntfN.e
with debug

global constant CRASH = true    -- (may or may not help debugging [true=>ex.err, false=>msg in gui])
--global constant CRASH = false -- (may or may not help debugging [true=>ex.err, false=>msg in gui])

--DEV temp, until listview/treeview is up and running...
function shortast(object s)
    if sequence(s) then
        integer l = length(s)
        for i=1 to min(l,15) do
            s[i] = shortast(s[i])
        end for
        if l>16 then
            s[16..$] = {"..."}
        end if
    end if
    return s
end function

with trace
--trace(1)
--
--DEV?? - NO, use the shortest paths we can [DONE]
-- Aside: "include pwa\..." assumes pwa\ is a sister directory of builtins\ and 
--         works exactly the same way that eg include builtins\timedate.e does.
--         I have intentionally used that throughout, even though shorter paths
--         would probably work just as well, and maybe even a tiny bit better.
--
--include src\p2js_basics.e -- includes/constants/globals/utilities (included by next anyway)

--SUG:
--include src\p2js_vile.e                                               ""
-- Just somewhere for every man and his dog to throw their messy-messages, then later we can
-- come and get ourselves a tidy little summary, with excessive duplicates removed, etc.

include src\p2js_tok.e
include src\p2js_parse.e

--include builtins\xml.e -- (now in p2jsbasics.e, w/o debug)

procedure transpile(string filename)
    if load_file(filename) then
        if is_html() then
            sequence xml = strict_html_parse(src)
            pp(xml)
        else
            tokenise()
            if not tok_error() then
--?shorten(src,"chars")
printf(1,"Tokenised successfully (%,d chars, %,d tokens)\n",{lt,length(tokens)}) 
--?tokens
--pp(shorten(tokens,"tokens",3),{pp_Nest,1,pp_IntCh,false})
                sequence ast = parse()
                if not parse_error() then
--                  pp(ast)
                    pp(shortast(ast))
                end if
            end if
        end if
    end if
end procedure

--good:
--transpile(`C:\Program Files (x86)\Phix\pwa\phix\adp.exw`)                     -- [ 596 chars, 89 tokens ]         [OK!!] (auto-includes too!!)

--transpile(join_path({pwadir,`p2js.js`}))                                      -- [ 25,076 chars, 4,213 tokens ]   [OK!! (although SPREAD aka "..." ain't actually handled[??])]
--Xtranspile(join_path({pwadir,`pGUI.js`}))                                     -- [ 38,274 chars, 4,300 tokens ]   [OK!!] (this[i].removeAttribute(); - not really worth pursuing...)
--transpile(join_path({pwadir,`js`,`hello_world.html`}))                        -- [ 798 chars, 157 tokens ]        [OK!! (nonest)]
--transpile(join_path({pwadir,`hello_world.html`})) -- (if working on it)       -- [ 828 chars, 149 tokens ]        [OK!! (nonest)]
--X transpile(join_path({pwadir,`js`,`Simple_window.html`}))    -- (not there yet)
--transpile(join_path({pwadir,`Simple_window.html`}))   -- (if working on it)   -- [ 1,336 chars, 223 tokens ]      [OK!! (nonest)]
--transpile(join_path({pwadir,`phix`,`hello_world.exw`}))                       -- [ 360 chars, 58 tokens ]         [OK!!]
--transpile(join_path({pwadir,`phix`,`Simple_window.exw`}))                     -- [ 676 chars, 127 tokens ]        [OK!!]
--transpile(`C:\Program Files (x86)\Phix\test\t66prec.exw`)                     -- [ 1,224 chars, 345 tokens ]      [OK!!]
--transpile(`C:\Program Files (x86)\Phix\pwa\adp.html`)                         --                                  [OK!! (but no nested script yet)]
--transpile(`C:\Program Files (x86)\Phix\pwa.exw`)                              -- [ 24 chars, 6 tokens ]           [OK!!] (single include statement)
--transpile(`C:\Program Files (x86)\Phix\pwa\p2js.exw`)                         -- [ 81,781 chars, 729 tokens ]     [OK!!] -- looking good! (apart from a few "?"/DoQu())
--transpile(`C:\Program Files (x86)\Phix\pwa\src\p2js_basics.e`)                -- [ 15,139 chars, 1,333 tokens ]   [OK!!] -- **incomplete** nested enums (shd trigger an error)
--transpile(`C:\Program Files (x86)\Phix\pwa\src\p2js_tok.e`)                   -- [ 17,052 chars, 1,579 tokens ]   [OK!!] -- looking good!
--transpile(`C:\Program Files (x86)\Phix\pwa\src\p2js_tree.e`)                  -- [ 14,378 chars, 1,017 tokens ]   [OK!!]
--transpile(`C:\Program Files (x86)\Phix\pwa\src\p2js_keywords.e`)              -- [ 2,909 chars, 430 tokens ]      [OK!!] -- ok, apart from nested enums
--transpile(`C:\Program Files (x86)\Phix\pwa\src\p2js_parse.e`)                 -- [ 41,702 chars, 3,659 tokens ]   [OK!!] -- ish: T_forward, jstypes needs \n[DONE], (ditto ttval), static.
--transpile(`C:\Program Files (x86)\Phix\pwa\phix\IupTreeView.exw`)             -- [ 2,019 chars, 164 tokens ]      [OK!!] -- good (indent slightly askew)
--transpile(`C:\Program Files (x86)\Phix\builtins\xml.e`)                       -- [ 35,992 chars, 5,011 tokens ]   [OK!!] -- good (and_bits, or_bits, text[col], constant a, b?, utf32_to_utf8)
--transpile(`C:\Program Files (x86)\Phix\builtins\utfconv.e`)                   -- [ 19,232 chars, 1,227 tokens ]   [OK!!] -- and_bits, "\#EF\#BF\#BD", string subscripts
--transpile(`C:\Program Files (x86)\Phix\builtins\timedate.e`)                  -- [ 86,569 chars, 7,521 tokens]    [OK!!] -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\serialize.e`)                 -- [ 9,266 chars, 1,065 tokens ]    [OK!!] -- peek, getc, int_to_bytes, atom<=>float,...
--transpile(`C:\Program Files (x86)\Phix\builtins\regex.e`)                     -- [ 35,038 chars, 5,945 tokens ]   [OK!!] -- erm, constant -> const, not let!, ?9/0 -> crash("9/0")?
                                                                                                                            -- for/switch/exit problem(see pikevm_execute/MATCH), 
                                                                                                                            -- ready = ready[1..$-1] ==> ready = ready[1..-1-1]; ??
--transpile(`C:\Program Files (x86)\Phix\builtins\pqueue.e`)                    -- [ 8,656 chars, 809 tokens ]      [OK!!] -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\ordinal.e`)                   -- [ 4,222 chars, 817 tokens ]      [OK!!] -- good, apart from string[]
--transpile(`C:\Program Files (x86)\Phix\builtins\json.e`)                      -- [ 14,571 chars, 1,824 tokens ]   [OK!!] -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\complex.e`)                   -- [ 20,672 chars, 1,460 tokens ]   [OK!!] -- type
--transpile(`C:\Program Files (x86)\Phix\builtins\base64.e`)                    -- [ 6,952 chars, 891 tokens]       [OK!!] -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\pdecodeflags.e`)              -- [ 2,700 chars, 214 tokens]       [OK!!] -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\porall.e`)                    -- [ 864 chars, 130 tokens]         [OK!!] -- or_bits[u]
--transpile(`C:\Program Files (x86)\Phix\builtins\pmaths.e`)                    -- [ 3,828 chars, 581 tokens]       [OK!!] -- power, arctan
--transpile(`C:\Program Files (x86)\Phix\builtins\misc.e`)                      -- [ 12,003 chars, 475 tokens]      [OK!!] -- arctan, sqrt, type
--transpile(`C:\Program Files (x86)\Phix\builtins\log10.e`)                     -- [ 216 chars, 36 tokens]          [OK!!] -- log, INVLN10
--Xtranspile(`C:\Program Files (x86)\Phix\builtins\prnd.e`)                     -- [ ]                              [NO: #ilASM..]
--transpile(`C:\Program Files (x86)\Phix\builtins\psum.e`)                      -- [ 668 chars, 112 tokens ]        [OK!!] -- good (bar autoinclude...)
--transpile(`C:\Program Files (x86)\Phix\builtins\gcd.e`)                       -- [ 1,677 chars, 250 tokens ]      [OK!!] -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\factorial.e`)                 -- [ 1,559 chars, 167 tokens ]      [OK!!]  -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\pfactors.e`)                  -- [ 4,995 chars, 702 tokens ]      [OK!!]  -- good (floor, power, machine_bits?, remainder, get_[max]prime)
--transpile(`C:\Program Files (x86)\Phix\builtins\primes.e`)                    -- [                                        -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\pcase.e`)                     -- [                                        -- str[], enum for 'A' to 'Z'??? (test)
--transpile(`C:\Program Files (x86)\Phix\builtins\scanf.e`)                     -- [                                        -- baseset['0'+i], ch<'0'
--transpile(`C:\Program Files (x86)\Phix\builtins\to_int.e`)                    -- [                                        -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\wildcard.e`)                  -- [                                        -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\psqop.e`)                     -- [                                        -- good, xor()
--transpile(`C:\Program Files (x86)\Phix\builtins\psmall.e`)                    -- [                                        -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\pfindall.e`)                  -- [                                        -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\VM\pFind.e`) --[?]            -- [                                        -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\VM\pMatch.e`) --[?]           -- [                                        -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\bsearch.e`)                   -- [                                        -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\sort.e`)                      -- [                                        -- ASCENDING, routine_id, call_func (may be ok?)
--transpile(`C:\Program Files (x86)\Phix\builtins\punique.e`)                   -- [                                        -- enum
--transpile(`C:\Program Files (x86)\Phix\builtins\vslice.e`)                    -- [                                        -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\pextract.e`)                  -- [                                        -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\ptrim.e`)                     -- [                                        -- variable length slice substitution (shorten)
--transpile(`C:\Program Files (x86)\Phix\builtins\ptagset.e`)                   -- [                                        -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\substitute.e`)                -- [                                        -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\psplit.e`)                    -- [                                        -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\shuffle.e`)                   -- [                                        -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\permute.e`)                   -- [                                        -- remainder
--transpile(`C:\Program Files (x86)\Phix\builtins\pflatten.e`)                  -- [                                        -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\machine.e`)                   -- [    --?                                 -- no (alloc/poke...) so do manually, or not at all
--transpile(`C:\Program Files (x86)\Phix\builtins\ppp.e`)                       -- [                                        -- pp_xxx (maybe we should process psym/initialConstant()), escBytes, pp Red?
--transpile(`C:\Program Files (x86)\Phix\builtins\pdates.e`)                    -- OK                                       -- good
--transpile(`C:\Program Files (x86)\Phix\builtins\pcolumn.e`)                   -- [                                [OK!!]  -- good 
--transpile(`C:\Program Files (x86)\Phix\builtins\dict.e`)                      -- [                                [OK!!]  -- good, apart from type definition 
--transpile(`C:\Program Files (x86)\Phix\demo\pGUI\sample.exw`)                 -- fails on ",--\n}" (fixed)                -- erm, not at all sure about those images....
--transpile(`C:\Program Files (x86)\Phix\demo\pGUI\menu.exw`)                                                               -- soso
--transpile(`C:\Program Files (x86)\Phix\demo\pGUI\separator.exw`)                                                          -- good, but needs IupMenu() etc in pGUI.js finishing...
--transpile(`C:\Program Files (x86)\Phix\demo\pGUI\submenu.exw`)                                                            -- good
--transpile(`C:\Program Files (x86)\Phix\demo\pGUI\tee.exw`)                    -- nope, ifdef LINUX...
--transpile(`C:\Program Files (x86)\Phix\test\t01ee.exw`) --??

--Xtranspile(`C:\Program Files (x86)\Phix\test\swtime.exw`)     --#ilASM
--Xtranspile(`C:\Program Files (x86)\Phix\test\swtime2.exw`)    --""
--transpile(`C:\Program Files (x86)\Phix\test\t01type.exw`)     -- OK                                                       -- good, passes!
--transpile(`C:\Program Files (x86)\Phix\test\t02parms.exw`)                                                                -- good, passes!
--transpile(`C:\Program Files (x86)\Phix\test\t03showt.exw`)                                                                -- good, passes!
--transpile(`C:\Program Files (x86)\Phix\test\t04unary.exw`)                                                                -- good, passes!
--transpile(`C:\Program Files (x86)\Phix\test\t05inc0.exw`)     -- NO, but should fail gracefully... (scope rqd[ish])       -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t05inc0b.e`)      --  (duplicate/clashing z, p)
--transpile(`C:\Program Files (x86)\Phix\test\t06inc1.exw`)     -- namespace (ditto)
--transpile(`C:\Program Files (x86)\Phix\test\t06inc1b.e`)
--transpile(`C:\Program Files (x86)\Phix\test\t07inc2.exw`)
--Xtranspile(`C:\Program Files (x86)\Phix\test\t07inc2a.e`)     -- namespace
--transpile(`C:\Program Files (x86)\Phix\test\t07inc2b.e`)      -- ""
--transpile(`C:\Program Files (x86)\Phix\test\t07inc2c.e`)      -- ""
--transpile(`C:\Program Files (x86)\Phix\test\t07inc2d.e`)      -- ""
--transpile(`C:\Program Files (x86)\Phix\test\t08inc22.exw`)    -- OK
--transpile(`C:\Program Files (x86)\Phix\test\t08inc2a.e`)      -- namespace
--transpile(`C:\Program Files (x86)\Phix\test\t08inc2b.e`)
--transpile(`C:\Program Files (x86)\Phix\test\t08inc2c.e`)
--transpile(`C:\Program Files (x86)\Phix\test\t08inc2d.e`)
--transpile(`C:\Program Files (x86)\Phix\test\t09inc3.exw`)     -- namespace
--transpile(`C:\Program Files (x86)\Phix\test\t09inc31.e`)
--transpile(`C:\Program Files (x86)\Phix\test\t09inc32.e`)
--transpile(`C:\Program Files (x86)\Phix\test\t09inc3i.e`)
--transpile(`C:\Program Files (x86)\Phix\test\t09inc3j.e`)
--transpile(`C:\Program Files (x86)\Phix\test\t10inc4.exw`)     -- OK                                                       -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t10inc4a.e`)
--transpile(`C:\Program Files (x86)\Phix\test\t10inc4b.e`)
--transpile(`C:\Program Files (x86)\Phix\test\t10inc4c.e`)
--transpile(`C:\Program Files (x86)\Phix\test\t11inc5.exw`)                                                                 -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\inc5\t1.e`)
--transpile(`C:\Program Files (x86)\Phix\test\inc5\t2.e`)       -- OK
--transpile(`C:\Program Files (x86)\Phix\test\t12inc6.exw`)
--transpile(`C:\Program Files (x86)\Phix\test\t12inc6a.e`)
--transpile(`C:\Program Files (x86)\Phix\test\t12inc6b.e`)
--transpile(`C:\Program Files (x86)\Phix\test\t12inc6c.e`)
--transpile(`C:\Program Files (x86)\Phix\test\t13inc7.exw`)
--transpile(`C:\Program Files (x86)\Phix\test\inc7\Eric.exw`)   -- namespace
--transpile(`C:\Program Files (x86)\Phix\test\inc7\ALICE.E`)
--transpile(`C:\Program Files (x86)\Phix\test\inc7\BOB.E`)
--transpile(`C:\Program Files (x86)\Phix\test\inc7\CHRIS.E`)
--transpile(`C:\Program Files (x86)\Phix\test\inc7\DIANE.E`)
--transpile(`C:\Program Files (x86)\Phix\test\t14inc8.exw`)     -- OK
--transpile(`C:\Program Files (x86)\Phix\test\inc8/f0.exw`)
--transpile(`C:\Program Files (x86)\Phix\test\inc8/FILE1A.E`)
--transpile(`C:\Program Files (x86)\Phix\test\inc8/FILE1B.E`)
--transpile(`C:\Program Files (x86)\Phix\test\inc8/FILE2A.E`)
--transpile(`C:\Program Files (x86)\Phix\test\inc8/FILE2B.E`)
--transpile(`C:\Program Files (x86)\Phix\test\inc8/FILE2C.E`)
--Xtranspile(`C:\Program Files (x86)\Phix\test\t15inc9.exw`)    -- namespace
--Xtranspile(`C:\Program Files (x86)\Phix\test\t15inc9b.e`)
--Xtranspile(`C:\Program Files (x86)\Phix\test\t15inc9c.e`)
--Xtranspile(`C:\Program Files (x86)\Phix\test\t15inc9f.e`)
--Xtranspile(`C:\Program Files (x86)\Phix\test\t16incD.exw`)
--Xtranspile(`C:\Program Files (x86)\Phix\test\inc5\incD.e`)    -- namespace
--transpile(`C:\Program Files (x86)\Phix\test\t17incV.exw`)     -- OK                                                       -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\inc7\once.e`)     -- OK
--transpile(`C:\Program Files (x86)\Phix\test\t18equal.exw`)                                                                -- good!!! (less "a"=={'a'})
--transpile(`C:\Program Files (x86)\Phix\test\t19find.exw`)                                                                 -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t20cast.exw`)                                                                 -- good!!! (not really a test for p2js)
--transpile(`C:\Program Files (x86)\Phix\test\t21ret1.exw`)                                                                 -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t22cmp.exw`)                                                                  -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t23subsc.exw`)    -- OK                                                       -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t24slice.exw`)    -- ** O={3}; P=O; O[1]=5; ==> P!={3}....                    -- **BAD** (a deep_copy will fix it)
--transpile(`C:\Program Files (x86)\Phix\test\t25rmdr.exw`)                                                                 -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t26aprnd.exw`)    -- needs a dest = deep_copy(dest); in z(), then good.
--transpile(`C:\Program Files (x86)\Phix\test\t27rpeat.exw`)                                                                -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t28prntf.exw`)                                                                -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t29for.exw`)      -- OK                                                       -- good (skipping negative step)
--transpile(`C:\Program Files (x86)\Phix\test\t30prime.exw`)                                                                -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t31sce.exw`)      -- (more mods similar to sq_eq probably rqd)                -- good!!! 
--transpile(`C:\Program Files (x86)\Phix\test\t32sprnt.exw`)                                                                -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t33seqop.exw`)                                                                -- **BAD** (a deep_copy will fix it)
--transpile(`C:\Program Files (x86)\Phix\test\t34andor.exw`)                                                                -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t35cncat.exw`)                                                                -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t36match.exw`)                                                                -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t37misc.exw`)     -- (forward calls and serialize...)                         -- (else good!!!)           [*** DEV fix g() ***]
--transpile(`C:\Program Files (x86)\Phix\test\t38bltns.exw`)                                                                -- partial (see comments)
--transpile(`C:\Program Files (x86)\Phix\test\t39fio.exw`)      -- NO (correct type check error)
--transpile(`C:\Program Files (x86)\Phix\test\t39riomini.exw`)  -- ""
--transpile(`C:\Program Files (x86)\Phix\test\t39rndio.exw`)    -- NO (where undefined, as it should be)
--transpile(`C:\Program Files (x86)\Phix\test\t40rtnid.exw`)    --                                                          -- good (bar an include as)
--transpile(`C:\Program Files (x86)\Phix\test\t41infan.exw`)    -- #ilASM{}
--transpile(`C:\Program Files (x86)\Phix\test\t42cback.exw`)    -- #ilASM{}
--transpile(`C:\Program Files (x86)\Phix\test\t43tchk.exw`)     --                                                          -- good!!!!
--transpile(`C:\Program Files (x86)\Phix\test\t44silly.exw`)                                                                -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t45aod.exw`)
--Xtranspile(`C:\Program Files (x86)\Phix\test\t46ltype.exw`)   -- #istype()                            -- XX NO - don't go there!
--transpile(`C:\Program Files (x86)\Phix\test\t47ltth.exw`)                                                                 -- good!!!
--Xtranspile(`C:\Program Files (x86)\Phix\test\t48init.exw`)    -- #isinit()                            -- XX NO - not a real program
--Xtranspile(`C:\Program Files (x86)\Phix\test\t49ginfo.exw`)   -- #isginfo()
--Xtranspile(`C:\Program Files (x86)\Phix\test\t50gscan.exw`)   -- #ilASM{}
--transpile(`C:\Program Files (x86)\Phix\test\t51nstc.exw`)     -- OK                                                       -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t52oparm.exw`)    -- OK                                                       -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t53switch.exw`)                                                               -- good!!!
--Xtranspile(`C:\Program Files (x86)\Phix\test\t54inc.exw`)     -- (works with next commented out)
--Xtranspile(`C:\Program Files (x86)\Phix\test\t54inca.e`)      -- #isginfo()
--Xtranspile(`C:\Program Files (x86)\Phix\test\t55incinc.exw`)  -- (ditto)
--transpile(`C:\Program Files (x86)\Phix\test\t56inc.exw`)      -- forward call (ignore)
--transpile(`C:\Program Files (x86)\Phix\test\t56inca.e`)
--transpile(`C:\Program Files (x86)\Phix\test\t57masgn.exw`)                                                                -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t58rtxt.exw`)     -- XX NO (file i/o)
--Xtranspile(`C:\Program Files (x86)\Phix\test\t59mri.exw`)     -- XX (include "as")
--Xtranspile(`C:\Program Files (x86)\Phix\test\inc8/t59a.e`)    -- namespaces
--Xtranspile(`C:\Program Files (x86)\Phix\test\inc8/t59b.e`)
--note that namespaces are not supported by pwa/p2js: fairly obviously javascript is never going to support namespaces.
--  I suppose it is theoretically possible for the transpiler to perform a knucklehead substitution of say case:upper
--  to case_upper, verifying perfect consistency across the whole project and an absence of any unadorned references,
--  but it could so easily get it all wrong, and at the same time you could so easily do that yourself.
--hmm, on namespaces, I could (perhaps!) just map a:b to aXb, where X is \u02D0 (utf16) aka \#CB\#90 (utf8), a triangular colon...
--  (I would of course have to scan for consistency and apply the same to the original unadorned name, precisely just the once)
--  (We could also just map a:b to a$b, or maybe a__b, but a single underscore wouldn't be reversible.)
--transpile(`C:\Program Files (x86)\Phix\test\t60.exw`)         -- OK (NO, puts1.e)
--transpile(`C:\Program Files (x86)\Phix\test\t60td.exw`)       -- OK                                                       -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t61cffi.exw`)     -- NO (include builtins\cffi.e, could be cleaner...)
--transpile(`C:\Program Files (x86)\Phix\test\t62utf.exw`)                                                                  -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t63regex.exw`)    -- **needs forward definitions...**
--transpile(`C:\Program Files (x86)\Phix\test\t64struct.exw`)   -- no: class (erm, include builtins\structs.e, cffi:namespaces)
-- there could actually be reasonable mapping between structs and javascript objects...
--transpile(`C:\Program Files (x86)\Phix\test\t65filter.exw`)                                                               -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t66prec.exw`)     -- OK                                                       -- good!!!
--transpile(`C:\Program Files (x86)\Phix\test\t96jtyp.exw`)     -- OK                                                       -- good!!!
--Xtranspile(`C:\Program Files (x86)\Phix\test\t97mleak.exw`)   -- #ilASM{}
--transpile(`C:\Program Files (x86)\Phix\test\t98locks.exw`)    -- sleep(.1)...
--Xtranspile(`C:\Program Files (x86)\Phix\test\t99errs.exw`)    -- top-level abort(0) trick, don't go there...
--transpile(`C:\Program Files (x86)\Phix\test\terror.exw`)      -- OK ?database.e(ok), dll.e(ok), machine.e(ok), syswait.ew
--Xtranspile(`C:\Program Files (x86)\Phix\test\terrorX.exw`)    -- arwen
--transpile(`C:\Program Files (x86)\Phix\test\trace.exw`)       -- NO (uses inc7 which has clashes)
--https://rosettacode.org/wiki/Tetris/Phix
--demo\rosetta\Tetrominoes.exw
--file:///E:/downloads/misc/js/AbelianSandpile.html
--demo\rosetta\Abelian_sandpile_model.exw
-- or https://rosettacode.org/wiki/Abelian_sandpile_model#Phix (may be simpler)

--transpile(`C:\Program Files (x86)\Phix\pwa\python\pendulum.py`)   -- `def Animation(root):` [erm, is there really any point parsing python?]
--transpile(`C:\Program Files (x86)\Phix\pwa\c\jsmin.c`)        --                                  [static int the_a;...]
--  ???trace how it handles C:\Program Files (x86)\Phix\pwa\src\p2js_basics.e:260 global constant string charset = set_chars({{"\r\n",EOL},???
--transpile(`C:\Program Files (x86)\Phix\pwa\go\blackjack.go`)  -- hah, maybe one day... (get c working first!)
--C:\Program Files (x86)\Phix\demo\pGUI\IupMultiLine.c/exw (why not...)

function platform_is_js()   -- (for testing purposes, on desktop)
    return platform()==JS
--  return true
end function

--DEV fixme: [DONE, or was it("string") just skipped?]
global constant string initialcurrentdir = get_proper_dir(command_line()[2]),
                       inifile = join_path({initialcurrentdir,"p2js.ini"}),
                       testexw = join_path({initialcurrentdir,"test.exw"}),
                       testhtm = join_path({initialcurrentdir,"test.htm"})
--global constant string initialcurrentdir = get_proper_dir(command_line()[2])
--constant cl = command_line()
--global constant string initialcurrentdir = get_proper_dir(cl[2]),
--global constant string inifile = join_path({initialcurrentdir,"p2js.ini"})
string lastfile = ""

sequence files = {}

include pGUI.e
Ihandle main_dlg, choose_file, chosen, ctype, multitext, lbl_statusbar, otype,
        run_btn
Ihandln config
Ihandln tok_dlg = NULL, tok_table,
        tree_dlg = NULL, tree,
        show_dlg = NULL, show_text, lbl_show,
        opt_dlg = NULL, single_src, minimise, 
                        show_tokens_button, show_parse_button, 
                        show_collapsed, preserve_comments,
                        close_opts

function set_extensions(Ihandle ih, integer bar=0)
    for i=1 to length(ext_names)-bar do
        IupSetAttributeId(ih,"",i,ext_names[i])
    end for
    IupSetInt(ih,"VISIBLEITEMS",length(ext_names)+1) -- (no idea why +1 helps)
    return ih
end function

--DEVclear/retry on ctrl S, load, change xtype, etc?
sequence violations = {}

procedure add_violation(string msg)
    violations = append(violations,msg)
    --DEV set title, en/disable buttons etc...
end procedure

--with trace
function get_script(sequence xml, tags, res = {})
res = deep_copy(res)    --DEV (not particularly happy with that...)
    string tag = tags[1]
    tags = tags[2..$]
    for i=1 to length(xml) do
        object xmli = xml[i]
        if not sequence(xmli) then
            add_violation(sprint(xml))
            exit
        end if
        object xtag = xmli[1]
        if not string(xtag) then return {} end if
        if xtag=tag then
            if length(tags) then
                res = get_script(xmli[3],tags,res)
            elsif length(xmli[2])=0 then -- (not src=...)
                res = append(res,xmli[3])
--              res = append(res,deep_copy(xmli[3]))
            end if
        end if
    end for
    return res
end function

--global string src -- now in p2js_basics...
--integer src_offset    -- (for js embeddded in html) [ now in p2js_basics]
bool pGUI, pMPFR, pSHA256, pTIMEDATE

--function load(string src="", integer ext=0)
--function load(string what)
--DEV:
--function load_tokens(Ihandle mle=multitext)
function load_tokens(Ihandle mle=multitext, mtype=ctype)
--  if src="" then
    src = IupGetAttribute(mle, "VALUE")
    src_offset = 0
    pGUI = false
    pMPFR = false
    pSHA256 = false
    pTIMEDATE = false
--  integer ext = IupGetInt(ctype,"VALUE")
    integer ext = IupGetInt(mtype,"VALUE")
--  elsif ext=0 then
--      ?9/0 -- (sanity check)
--  end if
    if load_text(src,ext) then
        if is_html() then
            sequence xml
--if length(src)>78825 then
--  string l100 = src[78700..78825]
--end if
--          try
                xml = strict_html_parse(src)
                if xml[1]=-1 then
                    ?xml
                    return false
                end if
--/*
            catch e
--DEV violation
                ?e
                return false
            end try
--*/
--          pp(xml,{pp_Nest,4})

            -- look for a script with no attributes, process it as js.
            sequence js = get_script(xml,{`html`,`body`,`script`})
--?length(js)
--pp(js,{pp_Nest,4})
            if length(js)!=1 then
                -- DEV message?
                return false
            end if
            string pre = src[1..match(js[1][1],src)]
            src_offset = length(split(pre,'\n'))-1
            pGUI = match("pGUI.js",pre)!=0
            pMPFR = match("mpfr.js",pre)!=0
            pSHA256 = match("sha256.js",pre)!=0
            pTIMEDATE = match("timedate.js",pre)!=0
            src = js[1][1]
            ext = find_extension("js")
            if not load_text(src,ext) then
--          if not load_text(js[1][1],ext) then
                return false
            end if
--end if
-- problem: syntax colouring is off by lots!
--          return false
        end if
        tokenise()
        if not tok_error() then
            return true
        end if
    end if
    return false
end function

function multitext_caret_cb(Ihandle /*ih*/, integer line, integer col)
    IupSetStrAttribute(lbl_statusbar, "TITLE", "Line %d, Col %d", {line, col})
    return IUP_DEFAULT
end function

function showtext_caret_cb(Ihandle /*ih*/, integer line, integer col)
    IupSetStrAttribute(lbl_show, "TITLE", "Line %d, Col %d", {line, col})
    return IUP_DEFAULT
end function

integer fdx = 0
sequence fokens
Ihandle fmle
string fsrc
sequence fstacked = {}
string show_caret = ""

function idle_action()
    --
    -- note: the ADDFORMATTAG_HANDLE call itself is the bit that is horrendously slow!
    --
    Ihandln formattags = IupUser("BULK=YES")
    if fdx=1 then
        IupSetAttribute(formattags,"CLEANOUT","YES")
    end if
    integer count = 0
    while fdx<=length(fokens) do
        Ihandle formattag = IupUser()
        count += 1
        integer {toktype, tokstart, tokfinish, l1, c1} = fokens[fdx], 
                l2 = l1, c2 = tokfinish-tokstart+c1
        string colour
        if toktype=COMMENT
        or toktype=BLK_CMT then
            while fdx<length(fokens)
              and find(fokens[fdx+1][TOKTYPE],{COMMENT,BLK_CMT}) do
                fdx += 1
            end while
            toktype = fokens[fdx][TOKTYPE]
            if toktype=BLK_CMT then
                {?,tokstart,tokfinish,?,c2,l2} = fokens[fdx]
                if l2>l1 then
--                  c2 = length(split(fsrc[tokstart..tokfinish],'\n')[$])+1
                    c2 = length(split(fsrc[tokstart..tokfinish],'\n')[$])-1
--?{fsrc[tokstart..tokfinish],c2}
                else
--                  c2 = tokfinish-tokstart+c1 -- (nb /not/ same as above)
                    c2 = tokfinish-tokstart+c2 -- (nb /not/ same as above)
                end if
            else -- COMMENT, aka Line Comment
                {?,tokstart,tokfinish,l2,c2} = fokens[fdx]
                c2 += tokfinish-tokstart
            end if
            IupSetAttribute(formattag, "ITALIC", "YES")
--?"italic"
            colour = IUP_NAVY
        else
            if toktype=LETTER then
                toktype = fokens[fdx][TOKTTIDX]
            end if
            if toktype=DIGIT
            or toktype='#' then
                colour = IUP_BLACK
            elsif find(toktype,{'"','\''}) then -- string
                colour = IUP_DARK_GREEN
            elsif toktype='`' then              -- multi-line string
                l2 = fokens[fdx][TOKENDLINE]
                if l2>l1 then
                    c2 = length(split(fsrc[tokstart..tokfinish],'\n')[$])-1
--              else
--                  c2 = tokfinish-tokstart+c1  -- (already done above)
                end if
                colour = IUP_DARK_GREEN
--?fsrc[tokstart..tokstart]
--?fsrc[tokstart-2..tokstart-1]
--?fsrc[tokfinish+1..tokfinish+2]
                if fsrc[tokstart-2..tokstart-1]=`""`
                and fsrc[tokfinish+1..tokfinish+2]=`""` then
                    fsrc[tokstart] = '"'
                    fsrc[tokfinish] = '"'
--                  tokstart -= 2
--                  tokfinish += 2
--?"2!"
                    c1 -= 2
                    c2 += 2
                end if
            elsif toktype<128                   -- symbols
              and toktype!=T_string
              and toktype!=T_nullable_string then
                colour = IUP_BLUE
            elsif toktype<256 
              and remainder(toktype,2)=1 then   -- multisym
                colour = IUP_BLUE
            elsif toktype<=T_object then        -- types
                colour = "#004080"
--          elsif toktype<=T_volatile then      -- dodgy keywords
--          elsif toktype<=T_try then           -- dodgy keywords
            elsif toktype<=T_trace then         -- dodgy keywords
                colour = IUP_RED
            elsif toktype<=T_xor then           -- keywords
                colour = IUP_TEAL
--          elsif toktype<=T_yield then         -- buitlins
--          elsif toktype<=T_xor_bitsu then         -- buitlins
            elsif toktype<=T_zIndex then        -- buitlins
                colour = "#7060A8"
--          elsif toktype<=T_wait_key then      -- not pwa/p2js
            elsif toktype<=T_yield then         -- not pwa/p2js
--DEV oh shit: if platform()!=WEB then ... end if - not violation...
--          (which suggests we should syntax colour off the back of a parse tree...)
--          (or, maybe, retro-apply from parse tree back onto the tokens...)
--          (or, they're only violations on output from generate_source...)
--DEV (DOH)     violations += 1
                colour = IUP_RED
if toktype=T_IupMainLoop then
--DEV... see what we can do...
--trace(1)
    if fdx>=8 
    and fokens[fdx-1][TOKTYPE]=LETTER
    and fokens[fdx-1][TOKTTIDX]=T_then
    and fokens[fdx-2][TOKTYPE]=LETTER
    and find(fokens[fdx-2][TOKTTIDX],{T_JS,T_JAVASCRIPT,T_WEB})
    and fokens[fdx-3][TOKTYPE]=NE
    and fokens[fdx-4][TOKTYPE]=')'
    and fokens[fdx-5][TOKTYPE]='('
    and fokens[fdx-6][TOKTYPE]=LETTER
    and fokens[fdx-6][TOKTTIDX]=T_platform
    and fokens[fdx-7][TOKTYPE]=LETTER
    and fokens[fdx-7][TOKTTIDX]=T_if then
        colour = "#7060A8"
    elsif fdx>=10
--else
--trace(1)
--  if fdx>=10
    and fokens[fdx-1][TOKTYPE]='{'
    and fokens[fdx-2][TOKTYPE]=')'
    and fokens[fdx-3][TOKTYPE]=LETTER
    and find(fokens[fdx-3][TOKTTIDX],{T_JS,T_JAVASCRIPT,T_WEB})
    and fokens[fdx-4][TOKTYPE]=NE
    and fokens[fdx-5][TOKTYPE]=')'
    and fokens[fdx-6][TOKTYPE]='('
    and fokens[fdx-7][TOKTYPE]=LETTER
    and fokens[fdx-7][TOKTTIDX]=T_platform
    and fokens[fdx-8][TOKTYPE]='('
    and fokens[fdx-9][TOKTYPE]=LETTER
    and fokens[fdx-9][TOKTTIDX]=T_if then
        colour = "#7060A8"
--  else
--      pp({"IupMainLoop",fokens[fdx-10..fdx]})
    end if
--end if
--/*
--js:
{"get_type",14888,2,"==>",0}
{"LETTER",721,731,18,16,14888,"yellowstone"}
Error in C:\Program Files (x86)\Phix\builtins\ppp.e line 18, column 17
sequence y500 = yellowstone(500)
                ^ warning: unrecognised
{"autoincludes:",{}}
{`IupMainLoop`,
 {{59';',978,978,37'%',12},
  {4,980,981,38'&',0,1648},         T_if                            := 1648},
  {40'(',983,983,38'&',3},          
  {4,984,991,38'&',4,6856},         T_platform                      := 6856},
  {40'(',992,992,38'&',12},
  {41')',993,993,38'&',13},
  {161,994,995,38'&',14},           NE      := 161
  {4,996,997,38'&',16,13216},       T_JS                            := 13216}, (also T_JAVASCRIPT := 13208, T_WEB := 13788)
  {41')',998,998,38'&',18},
  {123'{',1000,1000,38'&',20},
  {4,1006,1016,39'\'',4,10152}}}    T_IupMainLoop                   := 10152},
--phix:
{`IupMainLoop`,
 {{40'(',940,940,25,7},
  {4,941,943,25,8,14904},
  {41')',944,944,25,11},
  {4,946,947,26,0,1648},    T_if                            := 1648},
  {4,949,956,26,3,6856},    T_platform                      := 6856},
  {40'(',957,957,26,11},
  {41')',958,958,26,12},    
  {161,959,960,26,13},      NE      := 161
  {4,961,962,26,15,13216},  T_JS                            := 13216}, (also T_JAVASCRIPT := 13208, T_WEB := 13788)
  {4,964,967,26,18,1816},   T_then                          := 1816},
  {4,973,983,27,4,10152}}}  T_IupMainLoop                   := 10152},
--*/
end if
            elsif toktype<=T_WEB then           -- constants
                colour = "#004600"
            else                                -- everything else
                colour = IUP_BLACK
            end if
        end if
--?{l1,c1+1,l2,c2+2,colour,fokens[fdx]}
        IupSetStrAttribute(formattag,"SELECTION","%d,%d:%d,%d",{l1,c1+1,l2,c2+2})
        IupSetAttribute(formattag, "FGCOLOR", colour)
        IupAppend(formattags, formattag)
        fdx += 1
        if count>1000 then exit end if
    end while
--?fdx
    IupSetAttribute(fmle,"ADDFORMATTAG_HANDLE",formattags)
    -- erm, this enforces a behaviour I'd rather not have in the first place...
--  IupSetAttribute(fmle,"CARET","1,1")
--  IupSetAttribute(fmle,"SCROLLTO","1,1")
    Ihandle lbl = iff(fmle=multitext?lbl_statusbar:lbl_show)
    if fdx>length(fokens) then
        if fmle!=multitext and length(show_caret) then
--?{"CARET/SCROLLTO",show_caret}
            IupSetAttribute(show_text,"SCROLLTO",show_caret)
            IupSetAttribute(show_text,"CARET",show_caret)
            show_caret = ""
            integer {l,c} = IupGetIntInt(show_text,"CARET")
            {} = showtext_caret_cb(show_text,l,c)
        else
            IupSetStrAttribute(lbl, "TITLE", "Line 1, Col 1")
        end if
        if length(fstacked) then
            {fdx,fokens,fmle,fsrc} = fstacked
            fstacked = {}
            return IUP_DEFAULT
        else
            {fdx,fokens,fsrc} = {0,{},""}
            return IUP_IGNORE -- (disables idle)
        end if
    end if
    IupSetStrAttribute(lbl, "TITLE", "(syntax colouring %d%%)", {fdx/length(fokens)*100})
    return IUP_DEFAULT
end function
constant idle_action_cb = Icallback("idle_action")

function syntax_colour(Ihandle mle=multitext, mtype=ctype)
--if mle!=multitext then trace(1) end if
    if load_tokens(mle,mtype) then
--?{"sc",src_offset,fdx,length(tokens)}
        if src_offset then
            for i=1 to length(tokens) do
                tokens[i][TOKLINE] += src_offset
                if find(tokens[i][TOKTYPE],{BLK_CMT,'`'}) then
                    tokens[i][TOKENDLINE] += src_offset
                end if
            end for
        end if
        --
        -- First, "stack" anything in progress.
        --
        if length(fstacked) and fstacked[3]=mle then
            fstacked = {}
        end if
        if fdx!=0 and fmle!=mle then
            if length(fstacked) then ?9/0 end if -- sanity check
            fstacked = {fdx,fokens,fmle,fsrc}
        end if
        fokens = tokens
        fdx = 1
        fmle = mle
        fsrc = src
        IupSetGlobalFunction("IDLE_ACTION",idle_action_cb)
    end if
    return IUP_IGNORE -- (for key_cb)
end function

procedure set_otype(integer ext)
    IupSetInt(otype,"VALUE",iff(ext==PHIX?HTML:iff(ext==JSS?JSS:PHIX)))
end procedure       

include builtins/read_file.e
procedure open_file(string filename)
--  object str = read_file(filename)
    object str = get_text(filename)
    if sequence(str) then
        save_filename(filename)
--      IupSetStrAttribute(main_dlg, "TITLE", `pwa\p2js - %s`, {get_file_name(filename)})
        lastfile = filename
--?{"lastfile",lastfile}
        if platform_is_js() then
            IupSetStrAttribute(chosen, "TITLE", filename)
        else
            integer pdx = find(filename,files)
            if pdx=0 then
                files = append(files,filename)
                pdx  = length(files)
            end if
--3/5/21: (nice idea, but unworkable, removed 9/5/21)
--/*
            for j=pdx to 2 by -1 do
                files[j] = files[j-1]
                if j<=IupGetInt(chosen,"VISIBLEITEMS") then
                    IupSetAttributeId(chosen,"",j,files[j])
                end if
            end for
            pdx = 1
            files[pdx] = filename
--</3/5/21>
--*/
--17/5/21
            integer vis = IupGetInt(chosen,"VISIBLEITEMS")-1
            if pdx>vis then
--?{pdx,vis,filename}
--vis -= 1
                files[pdx] = files[vis]
                files[vis] = filename
                pdx = vis
--              IupSetAttribute(chosen,"VISIBLEITEMS",pdx+1)
            end if
            IupSetAttributeId(chosen,"",pdx,filename)
            IupSetInt(chosen,"VALUE",pdx)
        end if
        integer ext = find_extension(get_file_extension(filename))
        IupSetInt(ctype,"VALUE",ext)
--      IupSetInt(otype,"VALUE",iff(ext==PHIX?HTML:PHIX))
--      IupSetInt(otype,"VALUE",iff(ext==PHIX?HTML:iff(ext==JSS?JSS:PHIX)))
        set_otype(ext)
        IupSetInt(run_btn,"ACTIVE",true)
--      IupSetStrAttribute(multitext, "FILENAME", filename)
        IupSetAttribute(multitext,"CARET","1,1")
        IupSetStrAttribute(multitext, "VALUE", str)
        {} = syntax_colour()
        {} = multitext_caret_cb(multitext, 1, 1)
        if show_dlg!=NULL then
            --
            -- Aside: reposition when MainWindow reloaded, but
            --        *not* for the show/hide/edit/show cycle,
            --        which in fact manually saves/restores it.
            --
--?{"show_text,1,1"}
            IupSetAttribute(show_text,"CARET","1,1")
        end if
    end if
end procedure

--/*
function demoset()
    sequence res = {"p2js.exw",...}
    for i=1 to length(res) do
        res[i] = join_path({initialcurrentdir,res[i]})
    end for
    return res
end function
--*/

procedure load_ini()
    files = {}
    object lines = get_text(inifile,GT_LF_STRIPPED)
    if lines!=-1 then
--      integer pdx = 0
        sequence d = {}
        integer vi = 1
        for i=1 to length(lines) do
            if lines[i]!="" then
                string {lt,li} = apply(split(lines[i],":",true,2),trim)
                if lt="file" then
                    if find(li,files) then
                        crash("duplicate project")
                    end if
                    files = append(files,li)
                    string fp = get_file_path(li)
                    integer k = find(fp,d)
--  integer pdx = IupGetInt(chosen,"VALUE")
                    if length(files)<=10 or k=0 then
                        if k=0 then
                            d = append(d,fp)
                            files[$] = files[vi]
                            files[vi] = li
                        end if
--                      IupSetAttributeId(chosen,"",length(files),li)
                        IupSetAttributeId(chosen,"",vi,li)
                        vi += 1
                    end if
--      IupSetInt(chosen,"VALUE",pdx)
--      files = append(files,{})
--      IupSetInt(chosen,"VALUE",1)
--              elsif lt="output" then
--                  outputs[pdx] = li
                else
                    ?9/0
                end if
            end if
        end for
        IupSetInt(chosen,"VISIBLEITEMS",vi) -- (no idea why +1 helps)
    end if
--DEV on reflection, we might/probably want to do this without a gui... [laters]
--  (then again, length 3 might be just this, ie you need -run/build/out to...)
    sequence cl = command_line()
    -- open a file from the command line (?allow file association in Windows?)
    if length(cl)>2 then
        string filename = cl[3]
        open_file(filename)
--DEV/SUG
--  else
--      if length(files)=0 then
--          files = demoset()
--      end if
    elsif length(files) then
        IupSetInt(chosen,"VALUE",1)
        open_file(files[1])
    end if
end procedure

procedure save_ini()
    if platform()=JS then ?9/0 end if
    integer pdx = IupGetInt(chosen,"VALUE")
--  if pdx>1 then {tags[1],tags[pdx]} = {pdx,1} end if
--  if pdx>1 then tags[1..pdx] = tags[pdx]&tags[1..pdx-1] end if
    if pdx then
        sequence tags = tagset(length(files))
--      integer tp = tags[pdx]
--      while pdx>1 do
--          tags[pdx] = tags[pdx-1]
--          pdx -= 1
--      end while
--      tags[1] = tp
        tags[1] = pdx
        for i=2 to pdx do tags[i] = i-1 end for
        integer fn = open(inifile,"w")
        if fn=-1 then crash("cannot open "&inifile) end if
--1/5/21: keep the lot, for Ctrl T, and instead limit what we load into chosen
--      sequence d10 = {}
        for i=1 to length(tags) do
            integer ti = tags[i]
--          string fi = files[ti],
--                 fp = get_file_path(fi)
--          integer k = find(fp,d10)
--          if i<=10 or k=0 then
--              if k=0 then d10 = append(d10,fp) end if
--              printf(fn,"file: %s\n",fi)
                printf(fn,"file: %s\n",files[ti])
--          end if
        end for
        close(fn)
    end if
end procedure

function dropfiles_cb(Ihandle /*multitext*/, atom filename)
    open_file(peek_string(filename))
    return IUP_DEFAULT
end function

function multitext_valuechanged_cb(Ihandle /*multitext*/)
--DEV update syntax colouring... (on a timer?)
    if not platform_is_js() then
--      IupSetAttribute(chosen,"TITLE","")
        IupSetInt(chosen,"VALUE",NULL)
        current_file = ""
/*
        if length(lastfile) and not find(lastfile[$],`/\`) then
            lastfile = get_file_path(lastfile)
--          if IupGetInt(ctype)=
        end if
*/
    end if
    return IUP_DEFAULT
end function

Ihandln filedlg = NULL

----function closefiledlg_cb(Ihandle /*filedlg*/)
----?"closefiledlg_cb"
--function file_cb(Ihandle /*filedlg*/, atom /*pFileName*/, pStatus)    
--  string status = peek_string(pStatus)
--  if status="FINISH" then
--?"file_cb"
--      IupConfigDialogClosed(config, filedlg, "FileDlg")
--  end if
--  return IUP_CLOSE
--end function

function choose_cb(Ihandln /*choose_file*/)
    if filedlg=NULL then
        filedlg = IupFileDlg()
        IupSetAttribute(filedlg, "DIALOGTYPE", "OPEN");
        IupSetAttributePtr(filedlg, "PARENTDIALOG", main_dlg);
        IupSetAttribute(filedlg, "EXTFILTER", "All files|*.*|");
        IupSetAttribute(filedlg, "TITLE", "Select File");
--      IupSetAttribute(filedlg,"DIRECTORY",initialcurrentdir)
--      IupSetCallback(filedlg,"CLOSE_CB",Icallback("closefiledlg_cb")) -- NO!
--      IupSetCallback(filedlg,"FILE_CB",Icallback("file_cb"))          -- UGH! (not needed anyway, it seems)
        IupSetInt(filedlg,"MULTIPLEFILES ",false)
    end if
    string d = lastfile
--?{"choose_cb","lastfile",lastfile}
--/*
    string d = ""
    if platform_is_js() then
        d = IupGetAttribute(chosen,"TITLE")
    elsif length(files) then
        integer fdx = IupGetInt(chosen,"VALUE")
        if fdx then
            d = files[fdx]
        else
            d = lastfile
        end if
    end if
--*/
--  string d = iff(platform_is_js()?IupGetAttribute(chosen,"TITLE")
--               :iff(length(files)?files[IupGetInt(chosen,"VALUE")]
--                                 :""))
--  IupSetStrAttribute(filedlg,"DIRECTORY",iff(d!=""?get_file_path(d,true):initialcurrentdir))
    IupSetStrAttribute(filedlg,"DIRECTORY",iff(d!=""?get_file_path(d,true):initialcurrentdir))
--  IupSetStrAttribute(filedlg,"FILE",iff(d!=""?get_file_path(d,true):initialcurrentdir))
--  IupConfigDialogShow(config, filedlg, "FileDlg")
--  IupPopup(filedlg, IUP_CURRENT, IUP_CURRENT)
    IupPopup(filedlg)
    if IupGetInt(filedlg, "STATUS")!=-1 then
        string file = IupGetAttribute(filedlg, "VALUE")
--      if not find(file,files) then
--          files = append(files,file)
--          APPENDITEM 
--      end if
        open_file(file)
    end if
    return IUP_DEFAULT
end function

function chosen_cb(Ihandle /*chosen*/, atom /*pText*/, integer /*item*/, /*state*/)
    integer pdx = IupGetInt(chosen,"VALUE")
    open_file(files[pdx])
    return IUP_DEFAULT
end function

function ctype_cb(Ihandle /*ctype*/, atom /*pText*/, integer /*item*/, /*state*/)
    ext = IupGetInt(ctype,"VALUE")
--  IupSetInt(otype,"VALUE",iff(ext==PHIX?HTML:PHIX))
    set_otype(ext)
    IupSetInt(run_btn,"ACTIVE",true)
    return syntax_colour()
end function

-- we don't care/too late if Show window already open...
function otype_cb(Ihandle /*otype*/, atom /*pText*/, integer /*item*/, /*state*/)
    integer ext = IupGetInt(otype,"VALUE")
    bool bRunnable = (ext=PHIX or ext=HTML)
    IupSetInt(run_btn,"ACTIVE",bRunnable)
    return IUP_DEFAULT
end function

function selection_cb(Ihandle ih, integer id, status) 
    if status then
        ?{"selection_cb",id}
    end if
-- can we use TOTALCHILDCOUNTid to (quickly) navigate to the required node?
-- (and CHILDCOUNTid to ensure we're on-track)
-- (maybe NEXTid and USERDATAid...)
    return IUP_DEFAULT
end function

--DEV p2js_diag.e?

--
-- Aside: Text is generated on the fly from start/finish, hence sorting on that
--        behaves as if sorting on line number, but it's actually the finish.
--        Likewise although as expected, tokno is actually sorted on start.
--        Lastly toktype or ttidx then line ends up disturbingly subtly askew.
--
constant columns = {{"Toktype",  40,"ACENTER"},
                    {"#",        15,"ARIGHT"},
                    {"Text",    200,"ALEFT"},
                    {"Line",     15,"ARIGHT"},
                    {"Col",      15,"ARIGHT"},
                    {"ttidx",    15,"ARIGHT"}}

function toktype_fmt(sequence data, integer row, col)
    return tok_name(data[row][col])
end function

function tokno_fmt(sequence /*data*/, integer row, /*col*/)
    return sprintf("%d",row)
end function

function text_fmt(sequence data, integer row, col)
    sequence token = data[row]
    integer {toktype,start,finish} = token
    finish = min(finish,start+80)
    string txt = src[start..finish]
    if toktype=BLK_CMT
    or toktype='`' then
        txt = substitute(txt,"\n","\\n")
        if length(txt)>81 then txt = txt[1..81] end if
    end if
    return txt
end function

function commentify(sequence comment)
--  return {"commentify??",comment}
--if not integer(comment[2]) then ?9/0 end if
    integer {toktype,start,finish,?,tokaltype} = comment
    finish = min(finish,start+80)
    string txt = src[start..finish]
    if toktype=LETTER then
        if tokaltype>=1 and tokaltype<=length(TYPES) then
            txt &= " (" & TYPES[tokaltype][2] & ")"
        else
            txt &= sprintf(" (0b%04b)",tokaltype)
        end if
    end if
    txt = substitute(txt,"\n","\\n")
    if length(txt)>81 then txt = txt[1..81] end if
    return txt
end function

--constant SC = {"STATE","COLLAPSED"}
constant SC = {}

function treeify(sequence ast, bool bRoot=true)
--
-- Sanitise the real parse tree for display.
-- Obviously what is shown is not quite the same as the
-- one actually used, eg 10,000-line comments are a bit
-- different in the limited space available!
-- The parse tree is not set in stone: if this or any 
-- other part can be simplified, just go for it!
--
--?9/0
    if length(ast)!=2 then ?9/0 end if
--  if length(ast)!=2 then ?ast end if
--  {object nodetype, sequence children} = ast
    object {nodetype, children} = ast
    if integer(nodetype) then
        if nodetype=T_with
        or nodetype=T_without then
            children = children[1..1]
        elsif nodetype=T_include then
--          children = children[1..1]&sprint(childre
if not find(strip_builtin(children[1]),{"pGUI.e","mpfr.e","sha256.e","timedate.e"}) then
            restore_source(children[2])
end if
            children[2] = sprint(children[2])
            children = children[1..2]
        end if
--      nodetype = tok_name(nodetype)
        nodetype = substitute(tok_name(nodetype),"&","&&")
    end if
    sequence res = {nodetype,iff(bRoot?{}:SC),{}}
    if nodetype="new" and not is_phix() then
        if length(children)!=2 or children[1]!="PROC" then ?9/0 end if
--      children = {`PROC`,{{4,2859,2864,73'I',24,16200},{34'"',2866,2868,73'I',26},{34'"',2870,2872,73'I',30}}}
        children = children[2]
    end if
    if string(children) then
?{"can this happen anymore?? (treeify)",ast}
        res[$] = {children}
    elsif nodetype!="global"
      and nodetype!="use strict" then
        integer cdx=1
        while cdx<=length(children) do
            object child = children[cdx]
            cdx += 1
--/* (see e01.exw)
#istype{child,0b1111}
            if child={} then
#istype{child,0b1100}
                child = "{}"
            elsif child="" then
#istype{child,0b1100}
                child = `""`
            elsif integer(child) then
#istype{child,0b1111}
--DEVviolation? (or can this no longer happen now parse() is finished?)
--?"uhoh"
--{} = wait_key()
                ?9/0
--crash("oops")
            elsif not string(child) then
#istype{child,0b1111}
--*/
            if atom(child) then
                ?9/0
            elsif length(child)=0 then
                child = iff(string(child)?`""`:"{}")
            elsif not string(child) then
                object ctype = child[1]
                if find(ctype,{COMMENT,BLK_CMT}) then
                    integer first = cdx -- (-1 really)
                    while cdx<=length(children)
                      and length(children[cdx])>=1
                      and find(children[cdx][1],{COMMENT,BLK_CMT}) do
                        cdx += 1
                    end while
                    if cdx=first then
                        child = {"comment",SC,{commentify(child)}}
                    else    
                        child = {"comments",SC,{commentify(child)}}
                        for i=first to cdx-1 do
                            child[3] = append(child[3],commentify(children[i]))
                        end for
                    end if
                elsif find(ctype,{LETTER,DIGIT,'`'})
                   or find(ctype,`$'~?"#`) then
                    child = commentify(child)
                elsif length(child)=1
                   or (find(child[1],{T_exit,T_return,T_break,T_fallthrough}) and integer(child[2])) then
                    child = tok_name(child[1])
                else
                    child = treeify(child,false)
                end if
            end if
            res[$] = append(res[$],child)
        end while
    end if
    return res
end function

function close_sub_cb(Ihandle dlg)
    -- close (hide) a sub-window
    if opt_dlg!=null and dlg=close_opts then dlg = opt_dlg end if
    if not platform_is_js() then
--      string dlg_name = IupGetAttribute(dlg,"DLG_NAME")
        string dlg_name = substitute(IupGetAttribute(dlg,"TITLE")," ","")
        if dlg_name="" then ?9/0 end if
        IupConfigDialogClosed(config, dlg, dlg_name)
    end if
    IupHide(dlg)
    return IUP_DEFAULT
end function

include src\p2js_emit.e

procedure copy(string s)
    Ihandln ih = IupClipboard() 
    IupSetAttribute(ih,"TEXT",NULL) -- 6/5/21 (otherwise Edita [etc] stubbornly copies the old Unicode text)
    IupSetAttribute(ih,"TEXT",s)
    ih = IupDestroy(ih)
end procedure

include src/p2js_htmlise.e

function openFile(integer /*opening*/, string filepath, integer /*encoding*/)
    open_file(filepath)
    return true
end function

procedure test(string filename, src, cmd)
    integer fn = open(filename,"w")
    puts(fn,src)
    close(fn)
--  if find(' ',cmd) then
--      cmd = '"' & cmd & '"'
--  end if
    if length(cmd) then -- (not the "quietly save" of "OUTPUT")
        if find(' ',filename) then
            filename = '"' & filename & '"'
        end if
--      integer mode = iff(match(".exe",cmd)?2:4)
        integer mode = iff(match(".exe",cmd)?8:4)
        cmd = sprintf(`%s %s`,{cmd,filename})
        if length(cmd)>5 
        and cmd[1..5]="open " then  -- (note the space)
            cmd = cmd[6..$]
        end if
--?{cmd,mode}
        atom res = system_exec(cmd,mode)
--      atom res = system_exec(cmd,4)
--      atom res = system_exec(cmd,0)
--      atom res = system_exec(cmd,12)
--      atom res = system_exec(cmd,8)
--?res
--      system(cmd)
--?"done"
    end if
end procedure

procedure cannot_run(string ext)
    printf(1,"Cannot run .%s files\n",{ext})
end procedure

procedure run(string src, Ihandle mtype)
--DEV write test.exw/html, get_interpreter()/"open"
--  integer e = IupGetInt(mtype,"VALUE")
/*
?IupGetAttribute(chosen,"TITLE")
>>>
        if platform_is_js() then
            IupSetStrAttribute(chosen, "TITLE", filename)
        else
            integer pdx = find(filename,files)
            if pdx=0 then
                files = append(files,filename)
                pdx  = length(files)
            end if
            IupSetAttributeId(chosen,"",pdx,filename)
            IupSetInt(chosen,"VALUE",pdx)
        end if
        IupSetInt(chosen,"VALUE",1)
        open_file(files[1])
    integer pdx = IupGetInt(chosen,"VALUE")
--*/
    string d = lastfile
--/*
    string d = ""
    if platform_is_js() then
        d = IupGetAttribute(chosen,"TITLE")
    elsif length(files) then
        integer fdx = IupGetInt(chosen,"VALUE")
        if fdx then
            d = files[fdx]
        end if
    end if
--*/
    string ext = get_file_extension(d)
--?ext
    if length(ext)=0 or mtype=otype then
--?ext
        ext = extensions[IupGetInt(mtype,"VALUE")][2][1]
    end if
    if platform_is_js() then
        if ext="js" then
            puts(1,"run() not implemented")
        else
            cannot_run(ext)
        end if
    else
        if ext="exw" then
--          test(testexw,src,get_interpreter(bQuote:=false,bPrefW:=true))
            test(testexw,src,get_interpreter(true,machine_bits(),platform(),true))
--get_interpreter(bool bQuote=false, object mb=machine_bits(), integer plat=platform(), bool bPrefW=false)
        elsif ext="html" then
            test(testhtm,src,"open")
        else
            cannot_run(ext)
        end if
    end if
end procedure

function single_src_cb(Ihandle /*single_src*/, integer state)
--ih: identifier of the element that activated the event.
--state: 1 if the toggle’s state was shifted to on; 0 if it was shifted to off. 
--  if state then
--  else
--  end if
    IupConfigSetVariableInt(config,"Options","single_src",state)
    IupSetInt(minimise,"VALUE",iff(state?IupConfigGetVariableInt(config,"Options","minimise",false):false))
    IupSetInt(minimise,"ACTIVE",state)
    return IUP_DEFAULT
end function

function minimise_cb(Ihandle /*minimise*/, integer state)
    IupConfigSetVariableInt(config,"Options","minimise",state)
    IupSetInt(preserve_comments,"ACTIVE",not state)
    return IUP_DEFAULT
end function

function show_tokens_button_cb(Ihandle /*show_tokens_button*/, integer state)
    IupConfigSetVariableInt(config,"Options","show_tokens_button",state)
    return IUP_DEFAULT
end function

function show_parse_button_cb(Ihandle /*show_parse_button*/, integer state)
    IupConfigSetVariableInt(config,"Options","show_parse_button",state)
    return IUP_DEFAULT
end function

function show_collapsed_cb(Ihandle /*show_collapsed*/, integer state)
    IupConfigSetVariableInt(config,"Options","show_collapsed",state)
    return IUP_DEFAULT
end function

function preserve_comments_cb(Ihandle /*preserve_comments*/, integer state)
    IupConfigSetVariableInt(config,"Options","preserve_comments",state)
    return IUP_DEFAULT
end function

--procedure rebuild()
--end procedure

function insert_dollars(string text, sequence gk)
    --
    -- prefix private identifiers in pwa/builtins/.js files with a $,
    -- to ensure that they clash not with anything in user-code-land.
    -- eg (local constant) "PDATA" in builtins/pqueue.js ==> "$PDATA".
    -- text is the generated js, gk is the list of local identifiers.
    -- note that a gk of eg {"pq","pq_compare"} must not dbl-whammy,
    --      nor must that "pq" mangle "pq_size", "init_pq", etc.
    -- one missed was "hundred" -> "$hundred" in builtins\ordinal.e,
    -- so it now also checks for lead/trail '"'/'`', but of course
    -- (say) the string " hundred and " might still get mangled....
    --
    integer lg = length(gk)
    if lg=0 then ?9/0 end if
    sequence dollars = {}
    for i=1 to lg do
        string gki = gk[i]
        integer lk = length(gki)
        sequence di = match_all(gki,text)
        for j=1 to length(di) do
            integer dij = di[j],
                    idx = dij+lk
            if idx<=length(text) then
                integer nextch = text[idx],
                        chtype = charset[nextch]
                if not find(chtype,{'"','`',DIGIT,LETTER}) then
                    integer prevch = text[max(1,dij-1)]
                    chtype = charset[prevch]
                    if not find(chtype,{'"','`',DIGIT,LETTER}) then
                        dollars &= dij
                    end if
                end if
            end if
        end for
    end for
    dollars = sort(dollars)
    for i=2 to length(dollars) do
        -- sanity check for double-whammies
        if dollars[i] = dollars[i-1] then ?9/0 end if
    end for
    -- now insert a $ at all places we have decided on.
    string res = ""
    integer startidx = 1
    for i=1 to length(dollars) do
        integer di = dollars[i]
        res &= text[startidx..di-1]
        res &= '$'
        startidx = di
    end for
    res &= text[startidx..$]
    return res
end function

function verify(string generated, against)
    sequence gl = split(generated,"\n",false),
             ta = get_text(against,GT_LF_STRIPPED)
    bool bActual = false
    if length(gl)=length(ta)+1 and gl[$]=`` then
        gl = gl[1..$-1]
    end if
    if length(gl)!=length(ta) then
        printf(1,"incorrect lengths (%s)\n",{against})
        bActual = true
    else
        for i=1 to length(gl) do
            if gl[i]!=ta[i] then
                printf(1,"%s\n%s\nmismatch: %s line %d\n",{gl[i],ta[i],against,i})
                bActual = true
                exit
            end if
        end for
    end if
    if bActual then
        string actual = substitute_all(against,{"test.","exw.","js."},{"actual.","",""})
        integer fn = open(actual,"w")
        printf(fn,"Expected/generated output of %s\n",{against})
        puts(fn,generated)
        close(fn)
        printf(1,"see %s\n",{actual})
    end if
    return not bActual
end function

function validate(string testname, integer itype)
    string test     = join_path({pwadir,"src",testname}),
           test_js  = join_path({pwadir,"src",testname & ".js"}),
           test_exw = join_path({pwadir,"src",testname & ".exw"})
    init_scope()
--?test
    open_file(test)
    IupSetStrAttribute(lbl_statusbar,"TITLE","testing %s\n",{test})
    IupFlush()
    IupSetInt(ctype,"VALUE",itype)
    IupSetInt(otype,"VALUE",JSS)
    if not load_tokens() then ?9/0 end if
    sequence ast = parse()
    if parse_error() then ?9/0 end if
    if not verify(generate_source(ast,JSS,0,false,false,false,false),test_js) then
        return false
    end if
    IupSetInt(otype,"VALUE",PHIX)
    return verify(generate_source(ast,PHIX,0,false,false,false,false),test_exw)
end function

procedure rebuild_builtins_and_run_tests()
    integer waschosen = IupGetInt(chosen,"VALUE"),
            wasotype = IupGetInt(otype,"VALUE"),
            wasctype = IupGetInt(ctype,"VALUE")
--DEV set a flag to prevent reordering... [if we're still doing that in open_file() etc]
    string builtindir = join_path({get_file_path(get_interpreter()),"builtins"}),
           pwabuiltins = join_path({pwadir,"builtins"})
    for i=1 to length(rebuild_required) do
        string ri = strip_builtin(rebuild_required[i])
        if find(ri,{"pGUI.e","mpfr.e","sha256.e"}) then
            -- [see p2js_scope.e/check_builtins()]
            ?"rebuild_required includes "&ri&"..."
        else
            string filepath = join_path({builtindir,ri}),
                   pwabpath = join_path({pwabuiltins,substitute(ri,".e",".js")})
            init_scope()
            open_file(filepath)
--          open_file(filepath,bQuiet:=true)
            IupSetStrAttribute(lbl_statusbar,"TITLE","overwriting %s\n",{pwabpath})
            IupFlush()
--5/5 (spotted in passing...)
--          IupSetInt(otype,"VALUE",JS)
            IupSetInt(otype,"VALUE",JSS)
            if not load_tokens() then ?9/0 end if
            sequence ast = parse()
            if parse_error() then ?9/0 end if
            string output = generate_source(ast,JSS,0,false,false,false,false)
            sequence gk = get_autoincludes()[2] -- (overwrite p2js_depends.e if needed)
            if length(gk) then
                output = insert_dollars(output,gk)
            end if
            integer fn = open(pwabpath,"w")
            puts(fn,output)
            close(fn)
        end if
    end for
--  ?"run_tests"
--/*
On startup (desktop only) pwa/src/test.exw is transpiled to js and compared line-by-line to test.exw.js
and the same file is also "transpiled" to phix (iyswim) and compared line-by-line to test.exw.exw.
Likewise pwa/src/test.js is transpiled to phix/js and compared line-by-line to test.js.exw and test.js.js. 
--*/
    testing = true  -- let p2js_emit.e know...
    if validate("test.exw",PHIX) then
        {} = validate("test.js",JSS)
    end if
    testing = false -- let p2js_emit.e know...
    init_scope()

    IupSetInt(otype,"VALUE",wasotype)
    IupSetInt(ctype,"VALUE",wasctype)
    if waschosen then
        IupSetInt(chosen,"VALUE",waschosen)
        open_file(files[waschosen])
    end if
end procedure

function show_stuff(string what)

    if what="MEDIAWIKI" then
        bool bOut = show_dlg!=NULL and IupGetInt(show_dlg,"VISIBLE")
        Ihandle {mle,mtype} = iff(bOut?{show_text,otype}:{multitext,ctype})
        if load_tokens(mle,mtype) then
            if src_offset then
                for i=1 to length(tokens) do
                    tokens[i][TOKLINE] += src_offset
                    if find(tokens[i][TOKTYPE],{BLK_CMT,'`'}) then
                        tokens[i][TOKENDLINE] += src_offset
                    end if
                end for
            end if
            copy(htmlise(src,tokens))
        end if

    elsif what="FILELIST" then

        -- [hint: get_file_name_and_path(string filepath, bool dropslash=true), but we want the slash]
        sequence {filepaths, filenames} = columnize(apply(true,get_file_path_and_name,{files,false}))
        IupFileList(filenames, filepaths, openFile, main_dlg, config, "Recent Files")

    elsif what="CTRLF5" then

        run(IupGetAttribute(multitext,"VALUE"),ctype)

    elsif what="OPTIONS" then

--                   [options] Minimise: X off, X css, X css+js, X all. Split lines : 0+/- (max 132 or 512?)
-- show tokens and tree buttons (default no)
-- "show tree collapsed?"
-- preserve comments
--  preserve comments in builtins (or are we going to manually copy the lot into p2js.js?)
-- minify
--  embed p2js/pGUI.js/mpfr.js?
-- maybe: ctype/otype as radio buttons?
-- copy pop-up
--+++
--  return IUP_DEFAULT
--?"options"
        if opt_dlg=NULL then
            single_src = IupToggle("Single source",Icallback("single_src_cb"))
            minimise = IupToggle("Minimise",Icallback("minimise_cb"))
            preserve_comments = IupToggle("Preserve comments",Icallback("preserve_comments_cb"))
            show_tokens_button = IupToggle("Show tokens button",Icallback("show_tokens_button_cb"))
            show_parse_button = IupToggle("Show parse tree button",Icallback("show_parse_button_cb"))
            show_collapsed = IupToggle("Show tree collapsed",Icallback("show_collapsed_cb"))
            integer ss = IupConfigGetVariableInt(config,"Options","single_src",false),
                    mm = IupConfigGetVariableInt(config,"Options","minimise",false),
                    pc = IupConfigGetVariableInt(config,"Options","preserve_comments",true),
                    kb = IupConfigGetVariableInt(config,"Options","show_tokens_button",false),
                    pb = IupConfigGetVariableInt(config,"Options","show_parse_tree_button",false),
                    tc = IupConfigGetVariableInt(config,"Options","show_parse_tree_collapsed",true)
            IupSetInt(single_src,"VALUE",ss)
            IupSetInt(minimise,"VALUE",iff(ss?mm:false))
            IupSetInt(minimise,"ACTIVE",ss)
            IupSetInt(preserve_comments,"VALUE",pc)
            IupSetInt(preserve_comments,"ACTIVE",not ss or not mm)
            IupSetInt(show_tokens_button,"VALUE",kb)
            IupSetInt(show_parse_button,"VALUE",pb)
            IupSetInt(show_collapsed,"VALUE",tc)
            close_opts = IupButton("Close",Icallback("close_sub_cb"))
            Ihandle opt_vbox = IupVbox({IupHbox({single_src,minimise,preserve_comments}),
                                        IupHbox({show_tokens_button,show_parse_button}),
                                        IupHbox({show_collapsed}),
                                        IupHbox({IupFill(),close_opts})},
--                                      IupHbox({IupFill(),close_opts,IupFill()})},
--                                      IupHbox({close_opts})},
                                       "GAP=5, MARGIN=5x5")
            opt_dlg = IupDialog(opt_vbox) 
--          IupSetAttribute(opt_dlg,"RASTERSIZE","800x534") -- (see note)
            IupSetAttribute(opt_dlg,"TITLE","Options")
            IupSetAttributeHandle(opt_dlg,"PARENTDIALOG",main_dlg)
            IupSetCallback(opt_dlg, "CLOSE_CB", Icallback("close_sub_cb"))
        end if
        IupConfigDialogShow(config, opt_dlg, "Options")
        IupPopup(opt_dlg)

    elsif load_tokens() then

        if what="TOKENS" then

            sequence data = {tokens,{toktype_fmt,tokno_fmt,text_fmt}}
            if tok_dlg=NULL then
                tok_table = IupTable(columns,data)
                tok_dlg = IupDialog(tok_table) 
                IupSetAttribute(tok_dlg,"RASTERSIZE","800x534") -- (see note)
                IupSetAttribute(tok_dlg,"TITLE","Tokens")
                IupSetAttributeHandle(tok_dlg,"PARENTDIALOG",main_dlg)
--              IupSetAttribute(tok_dlg,"DLG_NAME","TokenWindow")
                IupSetCallback(tok_dlg, "CLOSE_CB", Icallback("close_sub_cb"))
            else
                IupTableSetData(tok_table, data, bReset:=true)
            end if
--          IupConfigDialogShow(config, tok_dlg, "TokenWindow")
            IupConfigDialogShow(config, tok_dlg, "Tokens")
            integer {width} = IupGetIntInt(tok_dlg,"CLIENTSIZE")
            {} = IupTableResize_cb(tok_dlg,width,0)

        else

--trace(1)
            sequence ast = parse()
            if parse_error() then
--DEV...
                ?"parse error"

            elsif what="PARSETREE" then

--              pp(ast)
--              pp(shortast(ast))
                sequence tree_nodes = treeify(ast)
--?1
--              pp(tree_nodes)
--              pp(shortast(tree_nodes))
                if tree_dlg=NULL then
                    tree = IupTreeView(tree_nodes)
                    IupSetCallback(tree, "SELECTION_CB", Icallback("selection_cb"))
                    tree_dlg = IupDialog(tree)
                    IupSetAttributeHandle(tree_dlg,"PARENTDIALOG",main_dlg)
                    IupSetAttribute(tree_dlg,"TITLE","Parse Tree")
                    IupSetAttribute(tree_dlg,"RASTERSIZE","660x830")
--                  IupSetAttribute(tree_dlg,"DLG_NAME","ParseWindow")
                    IupSetCallback(tree_dlg, "CLOSE_CB", Icallback("close_sub_cb"))
                else
--erm, why did I ever do this???
--                  string size = IupGetAttribute(tree_dlg,"RASTERSIZE")
--                  IupSetAttribute(tree,"DELNODE","ALL")
                    IupTreeAddNodes(tree,tree_nodes)
--                  IupSetAttribute(tree_dlg,"RASTERSIZE",size)
                end if
--              IupConfigDialogShow(config, tree_dlg, "ParseWindow")
                IupConfigDialogShow(config, tree_dlg, "ParseTree")

            else

                integer oval = IupGetInt(otype,"VALUE")
                string output = generate_source(ast,oval,src_offset,pGUI,pMPFR,pSHA256,pTIMEDATE)

                if what="OUTPUT" then

--DEV (spotted in passing... use the thingy)
                    if platform()!=JS then
                        -- quietly save...
--                      string ext = extensions[oval][2][1]
--                      if ext="exw" then
                        if oval=PHIX then
                            test(testexw,output,"")
--                      elsif ext="html" then
                        elsif oval=HTML then
                            test(testhtm,output,"")
                        end if
                    end if

                    if show_dlg=NULL then
                        show_text = IupText("MULTILINE=YES, EXPAND=YES, FORMATTING=YES")
                        IupSetAttribute(show_text, "READONLY", "YES")
                        IupSetAttribute(show_text, "FONT", "Consolas, 12")
                        IupSetStrAttribute(show_text,"BGCOLOR",IUP_SILVER)
                        IupSetCallback(show_text, "CARET_CB", Icallback("showtext_caret_cb"))
-->>>
                        lbl_show = IupLabel("Lin 1, Col 1")
                        IupSetAttributes(lbl_show, "EXPAND=HORIZONTAL,PADDING=10x5")
                        Ihandle vbox = IupVbox({show_text,lbl_show},"MARGIN=5x0")
                        show_dlg = IupDialog(vbox)
-->>>
--                      show_dlg = IupDialog(show_text) 
                        IupSetAttribute(show_dlg,"RASTERSIZE","700x700")
                        IupSetAttribute(show_dlg,"TITLE","Show")
                        IupSetAttributeHandle(show_dlg,"PARENTDIALOG",main_dlg)
--                      IupSetAttribute(show_dlg,"DLG_NAME","ShowWindow")
                        IupSetCallback(show_dlg, "CLOSE_CB", Icallback("close_sub_cb"))
                    end if
--                  string caret = IupGetAttribute(show_text,"CARET")
                    show_caret = IupGetAttribute(show_text,"CARET")
--?{"show_caret",show_caret}
                    IupSetAttribute(show_text,"VALUE",output)
                    {} = syntax_colour(show_text,otype)
--                  IupConfigDialogShow(config, show_dlg, "ShowWindow")
                    IupConfigDialogShow(config, show_dlg, "Show")
--                  if length(caret) then
--                      IupSetAttribute(show_text,"CARET",caret)
--                      IupSetAttribute(show_text,"SCROLLTO",caret)
--                  end if

                elsif what="COPY" then

                    copy(output)

                elsif what="RUN" then

                    run(output,otype)

                else
                    ?{"unknown:",what}
                end if
            end if
        end if
    end if
--IUP_IGNORE?
    return IUP_DEFAULT
end function

function show_tokens_cb(Ihandle /*show_tokens*/)
    return show_stuff("TOKENS")
end function

function parse_tree_cb(Ihandle /*parse_tree*/)
    return show_stuff("PARSETREE")
end function

function violations_cb(Ihandle /*parse_tree*/)
?"violations_cb"
    return IUP_DEFAULT
end function

function show_cb(Ihandle /*show_btn*/)
    return show_stuff("OUTPUT")
end function

function copy_cb(Ihandle /*copy_btn*/)
--  if ?? then -- DEV option
--      -- show copy pop-up
--      return IUP_DEFAULT
--  end if
    return show_stuff("COPY")
end function

--function mw_cb(Ihandle /*copy_btn*/)
--  return show_stuff("MW")
--end function

function run_cb(Ihandle /*run_btn*/)
    return show_stuff("RUN")
end function

function options_cb(Ihandle /*opt_btn*/)
    return show_stuff("OPTIONS")
end function

--The aim of the transpiler is to get new stuff working in the browser,
--not every crappy 20-year-old bit of obsolete code you can dredge up...

constant TITLE = `pwa\p2js - Phix to JavaScript transpiler`,
         help_text = """
Choose File or Ctrl O opens a standard file dialog.
Alternatively select a recent file or demo from the drop-down next to it.
Or press Ctrl T to open a filterable recent files popup. Note that the 
dropdown is limited to 10 files plus one per directory, to keep things
sensible, whereas the filterable popup has a much longer memory.
You can also drag and drop a file or paste (or type) into the edit area.
After pasting or typing, you may need to specify the source type, via the
top right downdown, which is otherwise set from the file extension.

Obviously the transpiler cherry-picks desktop features to emulate in the
browser alongside browser functionality to replicate on the desktop, 
and is *NOT* designed to run 20-year-old code without any changes.
That said, any error messages should be made as clear as possible.

Note the edit area is just a simple mle, NOT a full-fledged editor.
There is no official save option for the edit area, be warned that
extensive changes may be rudely discarded without any warning.
Syntax colouring is one-shot/full-file, NOT updated as you edit.
Actually, Ctrl-S will re-syntax-colour, but won't save the file at all.
Also note the syntax colouring is blandly generic: apart from a few
parse tweaks, phix/js etc are all actually coloured identically.
Line numbers are just not possible/would only work on Windows and
even then max out at 254 anyway ('cos it's a simple mle).

Tokens and Parse Tree are for diagnostics and information only.
 (and really only for use on pared-to-the-bone even at that)
n Violations (disabled when n=0, else next are) will show any errors.
Output type, Show, Copy, Run, Help, Close should be self explanatory.
Note that Copy has (will have) an option to show a detailed pop-up.
Changing output type won't correct input errors(!), top right may.

Options (desktop only) should be pretty self-explanatory, although 
at the moment only the rebuild builtins button is implemented.
You canno minimise unless generating single source, and you cannot
preserve comments if minimising. The show tokens and parse tree
buttons are development aids that most users do not need to see,
and besides Ctrl K/P show those windows anyway.

Non-phix-to-js is permitted, but should be considered experimental.
For instance c->phix is not meant to "work", but should save some time
converting all those "{","}" to "then", "do", "end function", etc.

There is no option to save any result, except Copy (to clipboard) or
using the -o command line option (obviously latter is desktop-only).

Command-line options allow this to be run without showing a gui, eg
        p pwa\p2js -[no]run demo.exw -o demo.html
        p pwa\p2js -? // show commandline options in detail
"""

function help_cb(Ihandle /*help_btn, or main_dlg*/)
--  if not platform_is_js() then
--      DEV either do the stopPropagation thing on Ctrl S or change it...
--  end if
    IupMessage(TITLE,help_text,bWrap:=false)
--  return IUP_DEFAULT
    return IUP_IGNORE
end function

procedure close_sub_windows(sequence swh)
    for i=1 to length(swh) do
        Ihandln ih = swh[i]
        if ih!=NULL and IupGetInt(ih,"VISIBLE") then
            {} = close_sub_cb(ih)
        end if
    end for
end procedure

function close_main_cb(Ihandle /*main_dlg or exit_btn*/)
    if not platform_is_js() then
        close_sub_windows({tok_dlg,tree_dlg,show_dlg})
        IupConfigDialogClosed(config, main_dlg, "MainWindow")
        {} = IupConfigSave(config)
        config = IupDestroy(config)
        save_ini()
    end if
    return IUP_CLOSE -- (for key_cb)
end function

function key_cb(Ihandle main_dlg, atom c)
    --
    -- Aside: a quick recap on those return values:
    --  IUP_IGNORE would eg spanner Ctrl C (if not handled here)
    --  IUP_CONTINUE as if this routine did not exist
    --  IUP_DEFAULT handle, but no further propagation
    --   => in most handled cases we want IUP_IGNORE
    --
-- add an option to reload (desktop only)
-- add cJ to output js (cW), ditto cH to output html (cW)
    switch c do
--case '!': ?9/0
        case K_F1:  return help_cb(main_dlg)
        case K_cO:  return choose_cb(choose_file)
        case K_cS:  return syntax_colour() -- (nb not save)
        case K_cM:  return show_stuff("MEDIAWIKI") -- (copy)
        case K_cN:  return show_stuff("OPTIONS")
        case K_cT:  return show_stuff("FILELIST")
        case K_cK:  return show_stuff("TOKENS")
        case K_cP:  return show_stuff("PARSETREE")
        case K_cW:  return show_stuff("OUTPUT")
--      case K_cC:  return show_stuff("COPY") -- NO! (cW/cA/cC is just fine)
        case K_F5:  return show_stuff("RUN")
        case K_cF5: return show_stuff("CTRLF5") -- (run original input)
        case K_ESC: return close_main_cb(main_dlg)
    end switch
    return IUP_CONTINUE
end function

function unnul(sequence s)
    s = filter(s,"out",{null})
    return s
end function
    
procedure create_main_dialog()

    choose_file = IupButton("Choose File",Icallback("choose_cb"))--,"PADDING=5x0, CANFOCUS=NO")
    if platform_is_js() then
        chosen = IupFlatLabel("","EXPAND=HORIZONTAL")
    else
        config = IupConfig()
        IupSetAttribute(config, "APP_CONFIG", "YES")
        IupSetAttribute(config, "APP_PATH", initialcurrentdir)
        IupSetAttribute(config, "APP_NAME", "p2js.exw")
--      IupSetAttribute(config, "APP_NAME", "p2js")
--      IupSetAttribute(config, "APP_NAME", "crap2js")
        {} = IupConfigLoad(config)
        chosen = IupList(Icallback("chosen_cb"),"DROPDOWN=YES,EXPAND=HORIZONTAL")
    end if
    ctype = set_extensions(IupList(Icallback("ctype_cb"),`DROPDOWN=YES`),1)
    Ihandle ch_box = IupHbox({choose_file,chosen,ctype},"MARGIN=5x5,GAP=10,NORMALIZESIZE=VERTICAL")
    multitext = IupText("MULTILINE=YES, EXPAND=YES, FORMATTING=YES")
--  multitext = IupText("MULTILINE=YES, EXPAND=YES")
    IupSetAttribute(multitext, "FONT", "Consolas, 12")
--  IupSetAttribute(multitext, "FONT", "Lucida Console, 11")
    IupSetCallback(multitext, "CARET_CB", Icallback("multitext_caret_cb"))
    IupSetCallback(multitext, "VALUECHANGED_CB", Icallback("multitext_valuechanged_cb"))
    IupSetCallback(multitext, "DROPFILES_CB", Icallback("dropfiles_cb"))
    IupSetStrAttribute(multitext,"BGCOLOR",IUP_SILVER)

    lbl_statusbar = IupLabel("Lin 1, Col 1")
    IupSetAttribute(lbl_statusbar, "EXPAND", "HORIZONTAL")
    IupSetAttribute(lbl_statusbar, "PADDING", "10x5")

    Ihandle show_tokens = IupButton("Tokens",Icallback("show_tokens_cb"))
    Ihandle parse_tree = IupButton("Parse tree",Icallback("parse_tree_cb"))
    Ihandle violations = IupButton("0 Violations",Icallback("violations_cb"))
--  IupSetStrAttribute(violations,"FGCOLOR",IUP_RED) -- DEV when non-zero, else IUP_BLACK
--DEV only active for 0 Violations (*3)
--DEV callback??? [NAH, erm YES!]
    otype = set_extensions(IupList(Icallback("otype_cb"),`DROPDOWN=YES`))
--  otype = set_extensions(IupList(`DROPDOWN=YES`))
--temp??
--  IupSetInt(otype,"VALUE",find("html",ext_names))
    IupSetInt(otype,"VALUE",find("phix",ext_names))
--SUG: if possible, show same top line on re-open...
    Ihandle show_btn = IupButton("Show",Icallback("show_cb"))
--SUG: make copy/run green if otype=ctype and text matches
    Ihandle copy_btn = IupButton("Copy",Icallback("copy_cb"))
--  Ihandle mw_btn = IupButton("MediaWiki",Icallback("mw_cb"))
--DEV only active for otype of phix or html (and 0 Violations)
    run_btn = IupButton("Run",Icallback("run_cb"))
--DEV desktop only??
    Ihandle opt_btn = IupButton("Options",Icallback("options_cb"))
    Ihandle help_btn = IupButton("Help",Icallback("help_cb"))
    Ihandle exit_btn = IupButton("Exit",Icallback("close_main_cb"))
    IupSetAttributes(unnul({choose_file,show_tokens,parse_tree,violations,
                      show_btn,copy_btn,run_btn,opt_btn,help_btn,exit_btn}),
                     "PADDING=5x0, CANFOCUS=NO")
--  IupSetAttributes({violations,copy_btn,run_btn},"ACTIVE=NO")
    IupSetAttributes({violations,run_btn},"ACTIVE=NO")
    Ihandle show_box = IupHbox({show_tokens,parse_tree,violations,IupFill(),
                                otype, show_btn,copy_btn,run_btn, IupFill(),
                                opt_btn,help_btn,exit_btn},"MARGIN=5x5,GAP=10")

    Ihandle vbox = IupVbox({ch_box,multitext,lbl_statusbar,show_box},"MARGIN=5x0")
    main_dlg = IupDialog(vbox,"RASTERSIZE=700x700")
--  IupCloseOnEscape(main_dlg,false)
    IupSetCallback(main_dlg, "DROPFILES_CB", Icallback("dropfiles_cb"))
    IupSetCallback(main_dlg, "CLOSE_CB", Icallback("close_main_cb"))
--  IupSetCallback(main_dlg, "K_ANY", Icallback("key_cb"));
    IupSetCallback(main_dlg, "KEY_CB", Icallback("key_cb"));

    -- parent for pre-defined dialogs in closed functions (IupMessage and IupAlarm)
    IupSetAttributeHandle(NULL, "PARENTDIALOG", main_dlg)

    -- initialize the current file
    IupSetAttribute(main_dlg, "TITLE", TITLE)
--  IupSetAttribute(multitext, "FILENAME", NULL)
    IupSetAttribute(multitext, "VALUE", "// Type, paste, drag and drop a file here, or click the button above...")

    /* show the dialog at the last position, with the last size */
    if platform_is_js() then
        IupShow(main_dlg)
    else
        load_ini()
        IupConfigDialogShow(config, main_dlg, "MainWindow")
--?"rebuild_builtins_and_run_tests() disabled p2js.exw line 2195"
        rebuild_builtins_and_run_tests()
    end if

    IupSetAttribute(multitext,"RASTERSIZE",NULL)

end procedure

sequence cl = command_line()
if length(cl)>2 then
    ?{"erm/DEV",cl}
    -- -test: compare src/test001.exw and src/test001.htm outputs.
    -- p pwa\p2js -norun -src test.exw -out test.html
end if

IupOpen()
IupSetGlobal("UTF8MODE","YES")
create_main_dialog()
if platform()!=WEB then
    IupMainLoop()
    IupClose()
end if

--?"done"
--{} = wait_key()
abort(0)

-- menus:
--/*
Notes: There is no support for mnemonics/accelerator/alt keys: Pressing eg ALt-F in the browser is going to open the browser's File menu,
        not the application-runnning-in-the-browser's (not that it can realistically have a "File menu" anyway). -- ERM...

window.addEventListener('keydown', function(e) {
  if (e.altKey == true && e.keyCode == 78)
    console.log('Alt + N'); 
});
    
(F12 or Alt L [test] you may also want/need to trap onkeyup, hunt through active window...)
document.onkeydown = function (event) {
    event = (event || window.event);
    if (event.keyCode === 123 || (event.keyCode === 76 && event.altKey)) {
        //do something
//maybe?:
//      event.preventDefault();
        return false;
    }
}

function selectLink(e) {
  let el = e.target;

  if (e.altKey) {
    window.open(el.getAttribute("alternative"), '_blank');
    e.preventDefault();
  }
}
<a href="http://www.google.com" onclick="selectLink(event)" alternative="http://www.yahoo.com">Click</a>

-- minification
-- ============
constant alphabet = tagset('z','a')&tagset('Z','A')&tagset('9','0')
constant alphabet = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789"
function short_id(integer n)
--
-- 52 one character ids, 
-- 3,224 two character ids, 
-- 199,888 three character ids,
-- 12,393,056 four character ids (that'll do!)
-- we do however have to avoid already used, keywords: i, by, to, do, in
-- it simply isn't worth trying to use any more than once, as it were,
-- and most common first is clearly the better strategy.
-- Also figure out the minimum conditions for needing to insert a space.
-- (Watch out for " ""?, - -, / /, + +, aZ9 aZ9,)
--
    string res = ""
    integer base = 52 -- (first char azAZ)
    while n do
        res &= alphabet[remainder(n-1,base)+1]
        n = floor((n-1)/base)
        base = 62 -- (subsequent chars azAZ09)
    end while
    return res
end function
puts(1,join_by(apply(tagset(3276),short_id),1,26,"."))
--?52*62
--?52*62*62
--?52*62*62*62


--pyjs:
-- (You ain't gona get nuthin fromthe sources!)
-- http://pyjs.org/examples/EmployeeAdmin.html
-- http://pyjs.org/examples/GChartTestApp.html
-- http://pyjs.org/examples/SVGCanvasDemo.html
-- http://pyjs.org/examples/GWTCanvasDemo.html
-- http://pyjs.org/examples/KitchenSink.html
-- http://pyjs.org/examples/lightout.html
-- http://pyjs.org/examples/Mail.html
-- http://pyjs.org/examples/minesweeper.html
-- http://pyjs.org/examples/PicasaWeb.html -?
-- http://pyjs.org/examples/events.html
-- http://pyjs.org/examples/graffle.html
-- http://pyjs.org/examples/spinner.html
-- http://pyjs.org/examples/Showcase.html   -- with source...
-- http://pyjs.org/examples/Slideshow.html
-- http://pyjs.org/examples/svg_test.html
-- http://pyjs.org/examples/Tabs.html

worth a look: https://github.com/MikeMcl/bignumber.js (gmp-like, 46 releases since 2013 and still going strong)

<div class="windowbar">
        <span>File</span><span>Editing</span><span>Search</span><span>Show</span><span>Navigation</span><span>Development</span><span>Tools</span><span>Help</span>
        <div class="controls">
                <span class="min"><ion-icon name="arrow-down"></ion-icon></span>
                <span class="max"><ion-icon name="arrow-up"></ion-icon></span>
                <a class="close" href="#save"><ion-icon name="close"></ion-icon></a>
        </div>
</div>

--CodePen_Export_PoZzeJB                                    Windows 98 looks, sticky drop, no hover, mnemonics, yuk
--CodePen_Export_rNBZajp                                X   sticky drop, good clear ex-click, no hover, no nesting that I can see... ugh: bootstrap+jquery (no idea why)
--conditional-right-click-menu                          pop-up, good clear ex-click, clean code, but looks a bit hideous. [not a proper menu at all]
--custom-right-click-context-menu                       ==> crud
--custom-right-click-menu                               ==> crud
disable-mouse-right-click                               (one-liner)
--drop-menu-by-hover                                        ==> crud
--expandable-menu                                       == crud
--  Another Simple CSS3 Dropdown Menu                   origin of fixed_header, -stick, +hover... css-only
fullscreen-utility-classes                              (meh)
--greedynav-update                                      ==> crud
--minimum-js-responsive-menu                                ==> crud
--responsive-nav-with-element-queries                   CORS bollocks...
--responsive-one-level-dropdown-menu-using-
--  css-transitions-and-jquery                          jQuery, single level, +resize, sticky drop, clear ex, no hover, (maybe)
--right-click-js                                            ==> crud (same as something ele)
--right-click-menu5                                     popup, hmm
--right-click-menu-by-smd                               popup, miss, no clear, not really
--right-click-menu-context                              popup, jQuery, miss, not really
--right-dropdown-menu                                   hover only, not really, some IE6 crud
--simple-drop-menu                                      hover only, css-only, ugly, not really.
--sticky-menu                                               nice, no clear, resize, but bootstrap+jQuery...
--windows-7-right-click-menu                                ==> crud (static only)

jQuery -> vanilla: (just the ones I have already used)
$(window)   - (ie no quotes) this is just a way of converting window to a jQuery-compatible-internal-structure.
let divs = $('div') --> let divs = document.querySelectorAll('div');
     (note that document.querySelector(selector) - fetches the first matching node only
                document.getElementById(idname) - fetches a single node by its ID name
                document.getElementsByTagName(tagname) - fetches nodes matching an element (e.g. h1, p, strong, etc).
                document.getElementsByClassName(class) - fetches nodes with a specific class name
      will all be faster)
$(document).ready(fn) --> document.addEventListener('DOMContentLoaded',fn);
$('a').click(fn) --> Array.prototype.forEach.call(document.querySelectorAll('a'), function(el) { el.addEventListener('click', fn); });
el.addClass('foo') --> el.classList.add('foo');
el.toggleClass('foo') --> el.classList.toggle('foo');
el.parent() -> el.parentNode;
$() -> $ = document.querySelectorAll;   (maybe...!)
$(el).on(eventName, eventHandler); --> el.addEventListener(eventName, eventHandler);
$.each(array, function(i, item){}); --> array.forEach(function(item, i){});
--http://youmightnotneedjquery.com/

B: box shadow
C: colours background grey & hover cyan
H: hits
S: space for icon and separator looking good
R: right click on menu item suppressed
X: clears when click (Xc) & escape & resize
N: nofocus on separator
W: min-width 120
Z: right height (or near enough, and in Tahoma 12 pt font)

Xpop1-right-click-menu-by-theprogrammingexpert          BCH    W    (popup, hits, no clear, not really)
Xpop2-right-click-menu2                                 BCH  Xc     popup, hits, good clear ex-click, fair code.
Xpop3-right-click-menu3                                 BCH  Xc     popup, hits, array->ul, otherwise so-so
Xpop4-custom-right-click-menu                           BC s Xc     popup, misses window, clean code, fair/maybe looks (wrong colour).
Xpop7-custom-context-right-click-menu-in-js-example     BC s X      pop-up, misses window, clean code, ugly, esc clear.         [**SEP/FOCUS**]
Xpop8-context-menu                                      BCH  Xc     pop-up, good clear ex-click, clean code, fractionally less hideous hits-x, misses-y [FIXED], noesc  [**NOSEP**]
Xpop9-customize-right-click-menu                        BCH RX W    pop_up, good clear ex-click (inc resize), hits window, clean code, nicer                            [**NOSEP**]
pop5-custom-right-click-menuadjustable                  BCHS xcWZ   popup, nested, no rt clear, ish code (array->ul), ul/li-based
pop6-custom-right-click-menu                            BCHSRXNWZ   popup, div-based
popA-right-click-menu                                   BCHSRXNWZ   popup, ul/li-based

--Aims:
-- looks reasonable: left space for possible icon, box-shadow, slim separators, 12px sans-serif
-- alt-key displays accelerator keys underlined (main bar only)
-- alt-X works
-- click outside and escape close window
-- nested menus show correctly
-- sticky, hover shifts - for resize/mobile, we can't have that jump [on lower menus] - but we can/should on desktop menus.

A: Alt keys (display underline only, more work needed once actions are in...)
B: box shadow
C: colours background grey & hover cyan
D: sticky drop
M: multilevel
N: nofocus on separator
P: ResPonsive
R: right click on menu item suppressed
S: space for icon and separator looking good
T: Tahoma 12pt (main bar)
X: clears when click (Xc) & escape & resize
W: min-width 120
Z: right height (or near enough, and in Tahoma 12 pt font)

--these five for the main:
Xsimple-css-drop-menu                                   _Bc_m____T_W_   hover only, nested, css-only, not really?
css-only-drop-menu                                                      hover only, clean code (css-only), ul/li-based, nested, no sep, not responsive.
pure-css-animated-navigation-menu                       _BC_MN__ST_WZ   hover only, ul/li-based, multilevel, no resize. [*** good, as far as we can go without js ***]
simple-window-menu-bar                                  aBCDmN__sT_WZ   sticky drop, ul/li-based, no nesting, but still a maybe
fixed-header-with-responsive-drop-down-sliding-menu     ABCDMNpRSTXWZ   sticky drop, ul/li-based, +resize [which got kinda broken..]
"done"

listviews/tables...
IupTable() <==
Aims:
C - Clickable and selectable lines (GAH, we need multi-select....)
--E - Editable in-place (as per the excel demo)
--F - Filter (as per Edix/file list, pdemo)
G - Grid lines
H - Headers properly shaded
K - keyboard up/down/cr
M - multiple selection
O - observable
S - proper sorting (numbers, dates, case-insensitive)
R - (auto)resizable [X and reorderable X] columns (Ain't no column reordering on t'desktop anyway)
P - resPonsive?
V - vertical scrollbar
# = don't try!
IupTable: Note that multiple selection only works on the desktop via a non-zero WIDTH0, pGUI.js does not yet support it (it may be slightly tricky due to tagsets, but doable)
file:///E:/downloads/misc/js/vanillajs/tables/observer/dist/index.html              CGHK_OSR_V  fast! - gone as far as we can for now... (whee, tree!)
file:///E:/downloads/misc/js/vanillajs/tables/keyboard/index.html                   CGHK_____V  [jQuery-GONE], keyboard handling
...tables/fixed-table-header-and-columns-in-bootstrap/dist/index.html               _GH___sR_V  NOICE! (ellipsis too) [slow sort]
..tables/really-responsive-tables-using-css-flexbox-complex/dist/index.html         __H_____P_  nice, div-based, but not sortable/selectable/no scrollbar/etc...
                                                                                                (mirrored as C:\Program Files (x86)\Phix\pwa\js\poc\responsive_tables.html)
==
E:/downloads/misc/js/vanillajs/magic-table/dist/index.html                          CGHk__sr#V  nice, sortable(meh), no column resize, table-based, somewhat messy innards (475 lines of js, 136 of css).
E:/downloads/misc/js/vanillajs/tables/resize-table-columns/dist/index.html          _g_____R_#  [*** - gone as far as I can with this, handles multiple tables]
file:///E:/downloads/misc/js/vanillajs/tables/mint/mint.html                        __H___s__v  proper sorting, but slow and wrong size
E:/downloads/misc/js/vanillajs/spreadsheet-using-javascript/dist/index.html         _GH_______      (jfw, table-based, fixed, Excel in 35 lines of js, 51 of css) n/r, but some styles maybe?
E:\downloads\misc\js\vanillajs\friedcell\examples.html                              CGH_M_s___  table-based
http://friedcell.si/js/SortedTable/                                                             -- excellent, however I'm now thing we should get sort() working first...
                                                                                                -- along with tagset and/or IupListView (develop that here, why not!) [DONE...]
XE:/downloads/misc/js/vanillajs/sort-table-with-just-javascript-js-css-html/dist/index.html     "" (but nah, 161 lines of js, 246 of css)
XE:/downloads/misc/js/vanillajs/sortable-table-pure-js/dist/index.html                          "" (92 lines of js, 66 of css)
E:/downloads/misc/js/vanillajs/vanillajs-sortable-table/dist/index.html                         table-based, rubbish sort (438 lines of js, of which 190 are dummy data, 141 of css)
E:/downloads/misc/js/vanillajs/responsive_table.html                                            table based, can we rework so css don't need to know #columns? [nah, uses shadows...]
..ds/misc/js/vanillajs/tables/drag-and-resize-table-columns/dist/index.html         __h__r__    [jQuery GONE, but nothing more to be had from this now]
E:/downloads/misc/js/vanillajs/tables/Clusterize/Fail/CodePen_Export_xVGvBv/dist/index.html     maybe...
E:/downloads/misc/js/vanillajs/tables/Clusterize/CodePen_Export_RRxyQb/dist/index.html          ""
file:///E:/downloads/misc/js/vanillajs/tables/Clusterize/index.html                             (gavve up)

http://phix.x10.mx/mint.html - (rework to allow local development... -- get a fresh copy of RC_POP.XML, maybe in json?)
 (oh, where's dat ting?^)											 -- better yet, use output from C:\Program Files (x86)\Phix\demo\rosetta\Rank_Languages.exw !!
C:\Program Files (x86)\Phix\demo\pGUI\listview.exw -- 227 lines (DONE, see demo/pGUI/IupTable.exw)
C:\Program Files (x86)\Phix\demo\arwendemo\demo_listview.exw -- 155 lines

// [IntersectionObserver is not supported on IE11 (released 2013)]

div ~ div (subsequent sibling)
div + div (next sibling)
div > span (child)
div span (descendant)

This is fair: (and of course you can probably cut it down to a single rule/class, programmatically)

this is the skinny: https://css-tricks.com/complete-guide-table-element/

Ihandle ih = IupTable(sequence columns,[[nullable_string action=NULL,] integer rid=NULL,] string attributes="", sequence data={}) 
--(add a bRid=false arg to paranormalise, cb_func(func) => iff(bRid?is_rid(func):cb_func(func)), iyswim.

trees:
Aims:
B - Box container + scrollbar
C - click select, not expand
F - Full line select
H - hover
I - inline pngs (then again, >1K a pop) - what about svgs?
S - inline svgs (instead of I)
K - keyboard up/down/cr
M - multiple selection


E:/downloads/misc/js/treeview/w3tree/w3tree.html                                    BCf____ ul-based (is it worth it?)
E:/downloads/misc/js/treeview/tree.js-master/example%20-%201/example.html           BCf_Sk_ that's it! (almost, just get rid of the trailing lines...) class-based...
E:/downloads/misc/js/treeview/a-css-treeview-control/dist/index.html                B_FH___ div/details-based class-based...
file:///E:/downloads/misc/js/treeview/js-treeview-master/example/index.html         BCFH___ div-based factory-based (ugh)...
file:///E:/downloads/misc/js/treeview/select-tag-dialog/dist/index.html             BCFH___ div-based buggy?
file:///E:/downloads/misc/js/treeview/vanillatree-master/demo.html                  BCFH___ ul-based (just replace with +/-, and[/or] maybe some icons) *** THIS ONE! *** (ugly though/bala)
file:///E:/downloads/misc/js/treeview/treeview-static/dist/index.html               bxFHI__ ul-based (box not quite right) hover, maybe...
===
...treeview/background-for-current-li-in-treeview-metro-4/dist/index.html           __F___  Yeah, but metro - abandoned!
file:///E:/downloads/misc/js/treeview/file-tree-example/dist/index.html             ______  single level? jQuery + bootstrap + crap anyway, abandoned!
file:///E:/downloads/misc/js/treeview/usmle-competencies/dist/index.html            ______  jquery/jstree - abandoned!
file:///E:/downloads/misc/js/treeview/css-only-treeview/dist/index.html             B_FH___ li-based (but hover ok!) [text center impossible, abandoned!]
E:/downloads/misc/js/treeview/aimaraJS-master/Example.html                          BCfh___ nice, but lots of separate images... fast, context menu[?] [NB: background lines wrong length] give up

tabs:
Only TABTYPE of TOP is currently supported. However, if you run pwa/js/poc/vanillatabs.html and (in the browser debug window) add 
display: flex to .tabs-container and remove it from .tabs, then you're probably 90% of the way to TABTYPE LEFT.
C:\Program Files (x86)\Phix\pwa\js\pocremove
E:/downloads/misc/js/vanillajs/tabs-with-vanillajs/dist/index.html                              nice ***
--Xfile:///E:/downloads/misc/js/uilang/examples/tabs/tabs/index.html                                simple

for images, we could do this:
constant filename = `E:\downloads\misc\js\vanillajs\Red-dot-5px.png`,
         filedata = get_text(filename)
?encode_base64(filedata)

"iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU5ErkJggg=="
<img src="data:image/png;base64,iVBORw0KGgoAAA
ANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4
//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHwAAAABJRU
5ErkJggg==" alt="Red dot" />
and/or:
ul.checklist li.complete {
    padding-left: 20px;
    background: white url('data:image/png;base64,iVB\
ORw0KGgoAAAANSUhEUgAAABAAAAAQAQMAAAAlPW0iAAAABlBMVEU\
AAAD///+l2Z/dAAAAM0lEQVR4nGP4/5/h/1+G/58ZDrAz3D/McH8\
yw83NDDeNGe4Ug9C9zwz3gVLMDA/A6P9/AFGGFyjOXZtQAAAAAEl\
FTkSuQmCC') no-repeat scroll left top;
}

graphs:
file:///E:/downloads/misc/js/vanillajs/graph/the-array-graph/dist/index.html
file:///E:/downloads/misc/js/vanillajs/graph/simple-barchart-generator/dist/index.html

file upload:
E:\downloads\misc\js\micro-code-editor-in-the-browser\drop.html<input type="file" name="file" id="file" class="inputfile" />

<label for="file">Choose a file</label>
let x = document.createElement("INPUT");
x.setAttribute("type", "file");

let dropArea = document.getElementById('drop-area')
dropArea.addEventListener('dragenter', handlerFunction, false)
dropArea.addEventListener('dragleave', handlerFunction, false)
dropArea.addEventListener('dragover', handlerFunction, false)
dropArea.addEventListener('drop', handlerFunction, false)       << this one!
event.preventDefault() is needed, otherwise the browser will open the file.

<div id="drop-area">
  <form class="my-form">
    <p>Upload multiple files with the file dialog or by dragging and dropping images onto the dashed region</p>
    <input type="file" id="fileElem" multiple accept="image/!*" onchange="handleFiles(this.files)">
    <label class="button" for="fileElem">Select some files</label>
  </form>
</div>
prism: a text input with opacity 0.7 overlaid exactly with a text output.
       just tokenise then -> eg <span class="token comment">..</span> & "none" as-is.

<style>
#drop-area {
  border: 2px dashed #ccc;
  border-radius: 20px;
  width: 480px;
  font-family: sans-serif;
  margin: 100px auto;
  padding: 20px;
}
#drop-area.highlight {
  border-color: purple;
}
p {
  margin-top: 0;
}
.my-form {
  margin-bottom: 10px;
}
#gallery {
  margin-top: 10px;
}
#gallery img {
  width: 150px;
  margin-bottom: 10px;
  margin-right: 10px;
  vertical-align: middle;
}
.button {
  display: inline-block;
  padding: 10px;
  background: #ccc;
  cursor: pointer;
  border-radius: 5px;
  border: 1px solid #ccc;
}
.button:hover {
  background: #ddd;
}
#fileElem {
  display: none;
}
</style>

<div id="drop-area">
  <form class="my-form">
    <p>Upload multiple files with the file dialog or by dragging and dropping images onto the dashed region</p>
    <input type="file" id="fileElem" multiple accept="image/!*" onchange="handleFiles(this.files)">
    <label class="button" for="fileElem">Select some files</label>
  </form>
  <div id="gallery"></div>
</div>

<scr!ipt>
let dropArea = document.querySelector('#drop-area');
;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, preventDefaults, false)
})

function preventDefaults (e) {
  e.preventDefault();
  e.stopPropagation();
}
;['dragenter', 'dragover'].forEach(eventName => {
  dropArea.addEventListener(eventName, highlight, false)
})

;['dragleave', 'drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, unhighlight, false)
})

function highlight(e) {
  dropArea.classList.add('highlight')
}

function unhighlight(e) {
  dropArea.classList.remove('highlight')
}
dropArea.addEventListener('drop', handleDrop, false)

function handleDrop(e) {
  let dt = e.dataTransfer
  let files = dt.files
  handleFiles(files)
}

function handleFiles(files) {
  files = [...files]
  files.forEach(uploadFile)
  files.forEach(previewFile)
}

function uploadFile(file) {
  let url = 'YOUR URL HERE'
  let formData = new FormData()

  formData.append('file', file)

  fetch(url, {
    method: 'POST',
    body: formData
  })
  .then(() => { /!* Done. Inform the user *!/ })
  .catch(() => { /!* Error. Inform the user *!/ })
}
function previewFile(file) {
  let reader = new FileReader()
  reader.readAsDataURL(file)
//FileReader.readAsText()
  reader.onloadend = function() {
    let img = document.createElement('img')
    img.src = reader.result
    document.getElementById('gallery').appendChild(img)
  }
}
</scr!ipt>


maybe, from https://developer.mozilla.org/en-US/docs/Web/API/HTMLScriptElement
[since I don't think we want phinglenook to load 1,277 examples...]
(sandfox/phixsty/phixplaypen/phixlenook/phideout/phlair/phixtum/phixicle/phix snug/
 phaven/phixtuary/phixster/phixude/phixroom/phixabode/phixloft/phixlab/phix snuggery)
function loadError(oError) {
  throw new URIError("The script " + oError.target.src + " didn't load correctly.");
}

function affixScriptToHead(url, onloadFunction) {
  let newScript = document.createElement("script");
  newScript.onerror = loadError;
  if (onloadFunction) { newScript.onload = onloadFunction; }
  document.head.appendChild(newScript);
  newScript.src = url;
}

or just:
function dynamicallyLoadScript(url) {
    let script = document.createElement("script");  // create a script DOM node
    script.src = url;  // set its src to the provided URL

    document.head.appendChild(script);  // add it to the end of the head section of the page (could change 'head' to 'body' to add it to the end of the body section instead)
}
(rather than a callback, have the script call anything that depends on it being loaded...)


-- https://www.codeproject.com/Articles/5291705/JavaScript-Playground
-- downloaded to: E:\downloads\misc\js\JavaScript-Playground (parse/read b4 run)

:root {
  /!* image from an external URL (PNG in this case) *!/
  --image-from-somewhere: url(https://codersblock.com/assets/images/logo.png);

  /!* image from embedded data (SVG in this case) *!/
  --image-embedded: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' 
viewBox='0 0 512 512'%3E%3Cpath d='M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 
184V72c101.705 0 184 82.311 184 184 0 101.705-82.311 184-184 184z'%3E%3C/path%3E%3C/svg%3E");
}

.a {
  background-image: var(--image-from-somewhere);
}

.b::after {
  content: var(--image-embedded);
}

The adjacent sibling combinator (+) is a simple example of how HTML influences CSS. 
The following style is only applied when a li is followed by another:
li + li { margin-top: 1rem; }
This example is quite expressive but doesn’t have to be
. Another example that took me a while to get as a beginner was using position: absolute on an element with a parent with position: relative. 
The element with position: absolute is positioned relative to the viewport or relative to an ancestor element with position: relative. 
In order to place this absolute element correctly in the interface, we have to know whether the element sits in a container with position: relative. 
Again, we’d have to look at the DOM, and at all it’s states, to be sure this is the case.

A similar, perhaps more familiar, example is the flex property. 
It only works if the element is a direct child of an element with the display: flex declaration.
*!/

--*/

-- borken: file:///C:/Program%20Files%20(x86)/Phix/pwa/adp.html
-- working: file:///E:/downloads/misc/js/pwa/adp.html

-- falsy (js): false, null, undefined, "", 0, NaN
-- false (phix): false, null, 0. undefined and "" raise an error, NaN is treated as true.
--if "" then ?`"" is true` else ?`"" is false` end if   -- error
--?iff(""?`"" is true`:`"" is false`)                   -- error
--atom inf = 1e300*1e300,
--   nan = -(inf/inf)
--?inf
--?nan
--?iff(nan?"nan is true":"nan is false")    -- true (phix)

--/* these?
for i=1 to 50 do
    printf(1,"%,12d",{product(factors(i,1))})
    if remainder(i,5)=0 then puts(1,"\n") end if
end for
Output:
           1           2           3           8           5
          36           7          64          27         100
          11       1,728          13         196         225
       1,024          17       5,832          19       8,000
         441         484          23     331,776         125
         676         729      21,952          29     810,000
          31      32,768       1,089       1,156       1,225
  10,077,696          37       1,444       1,521   2,560,000
          41   3,111,696          43      85,184      91,125
       2,116          47 254,803,968         343     125,000
functional
same output

sequence r = apply(apply(true,factors,{tagset(50),{1}}),product)
puts(1,join_by(apply(true,sprintf,{{"%,12d"},r}),1,5,""))
--*/
--/* from https://rosettacode.org/mw/index.php?title=Almost_prime#JavaScript
function almostPrime (n, k) {
    let divisor = 2, count = 0
    while(count < k + 1 && n != 1) {
        if (n % divisor == 0) {
            n = n / divisor
            count = count + 1
        } else {
            divisor++
        }
    }
    return count == k
}
 
for (let k = 1; k <= 5; k++) {
    document.write("<br>k=", k, ": ")
    let count = 0, n = 0
    while (count <= 10) {
        n++
        if (almostPrime(n, k)) {
            document.write(n, " ")
            count++
        }
    }
}

from https://rosettacode.org/mw/index.php?title=Almost_prime#Phix
sequence res = columnize({tagset(5)}) -- ie {{1},{2},{3},{4},{5}}
integer n = 2, found = 0
while found<50 do
    integer l = length(prime_factors(n,true))
    if l<=5 and length(res[l])<=10 then
        res[l] &= n
        found += 1
    end if
    n += 1
end while
string fmt = "k = %d: "&join(repeat("%4d",10))&"\n"
for i=1 to 5 do
    printf(1,fmt,res[i])
end for

--*/

-- Simple: Ihandle ih <==> let /* Ihandle */ ih
--    and: integer /*x*/ <==> let /* integer **/ x [ parameters only ]
-- Simple: ?x <==> print(1,x+"\n") [or just don't support it...]
-- AH: s[i] <==> s[i-1], and drop all that ["sequence",...] stuff... (strings would be fine that way too).
--      note: s[e], where e does not end in "-1", would be illegal in any js-->phix xpilation.
--      ditto s[i..j] <==> s[i-1..j-1], erm I mean s.slice(i-1?,j-1?).
-- NB: javascript does not permit negative substripts, but:
--  function at(n) {
--          // ToInteger() abstract op
--          n = Math.trunc(n) || 0;
--          // Allow negative indexing from the end
--          if(n < 0) n += this.length;
--          // OOB access is guaranteed to return undefined
--          if(n < 0 || n >= this.length) return undefined;
--          // Otherwise, this is just normal property access
--          return this[n];
--  }
--  // Other TypedArray constructors omitted for brevity.
--  for (let C of [Array, String, Uint8Array]) {
--      Object.defineProperty(C.prototype, "at",
--                            { value: at,
--                              writable: true,
--                              enumerable: false,
--                              configurable: true });
--  } //or:
--  Object.defineProperty(Array.prototype.at,"at",{value:at,writable:true,enumerable:false, ugh...
--  s[$] <==> s[s.length-1] or much better: $item(s,-1)
--  s[$-1] <==> $item(s,-2) ugh...
-- Maybe: let /* mpz */ bigIntSample = 1234567890987654321n; <==> mpz bigIntSample = mpz_new("1234567890987654321")
-- Maybe: cond ? truthy : falsy  <==> iff(cond?truthy:falsy)
-- Maybe: {a.b} @= c <==> [a, b] = repeat(c,2); (destructuring)
-- Ah-ha: {a,b} = {1,2} <==> [,a,b] = ["sequence",1,2]
-- Nested comments:
--          constant extensions = {{PHIX :=1, ...
-- <==>
--          const /*nested*/ PHIX=1, ...
--          const extensions = [[PHIX /*:=1*/, ...
--  NB: types are supported "in name only" by pwa/p2js, since there is no JavaScript equivalent. [added to docs]
-- for eg integer {?,optmin,optmax,greedy} = res2:
-- in js, let [,a,, b, ...rest] = [10, 20, 30, 40, 50]; ==> 20,40,[50].
--  NB: while optional parameters are fine, named p[arameters are not supported by p2js ... oh drat, timedelta
--          (can we find the definition and re-jig? timedelta(hours:=7, minutes:=30) <==> 
--           timedelta(/*:=*/0,/*:=*/0,/*hours:=*/7,/*minutes:=*/30[,0,0,0])? [iyswim])
--          (something similar for un-named parameters?)
-- Maybe: enum R,G,B <==> const /*enum*/ R=1,G=2,B=3;
--          (fixed literals that match expectation can simply be omitted, on the return trip)
-- Sug: try ... catch e ... end try <==> try { ... } catch(e) { e = $exception(e); ... } where
--  function $exception(e) { let res = ["sequence",0,0,0,0,0,"rtn_name","file",",path",e.message]; return res; }
--      (note: you don't get any line numbers or routine/file names, etc. They're just padding.)
--  In pwa/p2js, only the throw(string[,args]) variety is supported.
--  function $throw(e,args) { if (length(args)) { e = sprintf(e,args); } throw(e); }
--  function $throw(e,args) { if (length(args)) { e = sprintf(e,args); } throw new Error(e); }
--Note: <!DOCTYPE html> is self-closing, no "/>", parses as {`!DOCTYPE`, {}, {`html`}}. 
--      note that <meta charset='utf-8'/> parses as {{`meta`, {{`charset`}, {`utf-8`}}, {}},
--      conversely, <scr!ipt src="pGUI.js"></scr!ipt> parses as {`script`, {{`src`}, {`pGUI.js`}}, {``}},
--      **but** <scr!ipt src="pGUI.js"/> is illegal/unrecognised... (oh, they /are/ actually different...)
-- Erm: if platform()... [els...] end if <==> /* if platform()... */ <js> /* [els...] end if */ (error out if "else" but no explicit js branch)
--routine_id
--/* apparently this is legal in ES6...:
class X {
  method1(){
    console.log("1");
  }
  method2(){
    this['method1']();
    console.log("2");
  }
}
let x  = new X();
x['method2']();
--*/
--Challenge: https://www.codeproject.com/Articles/5284262/WPF-Drag-and-Drop-using-Behavior
--SUG: IupCustomAttribute(string name): if name="ANY" then go quiet, else add name to list of permitted attributes.
--  By default, the desktop will quietly set custom attributes and otherwise completely ignore them. Personally,
--  I've always rather disliked that because it means a simple typo can fail silently and therefore prove hard
--  to track down and/or get shipped unnoticed. Being allowed to set custom attributes is certainly a boon, and
--  took some of the sting off that behaviour. In pwa/p2js the situation is a little different, as I certainly
--  want a hard and immediate crash for as-yet-unimplemented / deliberately-never-to-be-implemented attributes. 
--  Hence IupCustomAttribute() is a null-op on the desktop. Note that the transpiler maintains a general list
--  and may (or may not) apply "localtypes", eg Ihandle label = IupLabel(); IupSetAttribute(label,"CANFOCUS")
--  might issue a transpile-time error that labels don't have a CANFOCUS attribute, however it must let more
--  generic code pass, eg procedure dostuff(Ihandle ih) IupSetAttribute(ih,"CANFOCUS"), whereas the runtime
--  can and will raise an error should dostuff() be passed an IupLabel, that is as long as there has not been
--  a prior invocation of IupCustomAttribute("CANFOCUS") or IupCustomAttribute("ANY"). Naturally in most cases
--  you would specify a bespoke attribute, say "USEDFOR", rather than anything documented in the help files.
--  Also note that IupCustomAttribute("USEDFOR") is itself generic and will allow that attribute to be set on
--  any element - there is no way to limit what types of elements or containers it can be applied to.
-- Maybe: https://github.com/GoogleChromeLabs/ProjectVisBug#visbug
-- Lots of good stuff: https://responsibleweb.app/
-- nice: https://www.codeproject.com/Articles/5293085/mojiWriter-An-App-to-Make-It-Easier-to-Use-and-Man
--       E:\downloads\misc\js\mojiWriter-main
-- maybe: https://www.codeproject.com/Articles/5292611/Fiddler-for-Model-Driven-Apps
-- HTML 5 DOCTYPE: <!DOCTYPE html>
-- php: error_reporting(E_ALL);
--/*
order.html:
<html>
 <body>

  <scr!ipt language="javascript" type="text/javascript">
function ajaxFunction(){
    let ajaxRequest = new XMLHttpRequest();
    // Create a function that will receive data sent from the server
    ajaxRequest.onreadystatechange = function(){
        if(ajaxRequest.readyState == 4){
            let ajaxDisplay = document.getElementById('ajaxDiv');
            ajaxDisplay.innerHTML = ajaxRequest.responseText;
        }
    }
    let age = document.getElementById('age').value,
        wpm = document.getElementById('wpm').value,
        sex = document.getElementById('sex').value,
        queryString = "?age=" + age + "&wpm=" + wpm + "&sex=" + sex;
    ajaxRequest.open("GET", "ajax-example.php" + queryString, true);
    ajaxRequest.send(null); 
}
  </scr!ipt>

  <form name='myForm'>
   Max Age: <input type='text' id='age' /> <br />
   Max WPM: <input type='text' id='wpm' /> <br />
   Sex: 
   <select id='sex'>
    <option value='m'>m</option>
    <option value='f'>f</option>
   </select>
   <input type='button' onclick='ajaxFunction()' value='Query MySQL' />
  </form>
  <div id='ajaxDiv'>Your result will display here</div>
 </body>
</html>

ajax-example.php:
<?php
$dbhost = "localhost";
$dbuser = "dbusername";
$dbpass = "dbpassword";
$dbname = "dbname";
//Connect to MySQL Server
mysql_connect($dbhost, $dbuser, $dbpass);
//Select Database
mysql_select_db($dbname) or die(mysql_error());
// Retrieve data from Query String
$age = $_GET['age'];
$sex = $_GET['sex'];
$wpm = $_GET['wpm'];
// Escape User Input to help prevent SQL Injection
$age = mysql_real_escape_string($age);
$sex = mysql_real_escape_string($sex);
$wpm = mysql_real_escape_string($wpm);
//build query
$query = "SELECT * FROM ajax_example WHERE ae_sex = '$sex'";
if(is_numeric($age))
    $query .= " AND ae_age <= $age";
if(is_numeric($wpm))
    $query .= " AND ae_wpm <= $wpm";
//Execute query
$qry_result = mysql_query($query) or die(mysql_error());

//Build Result String
$display_string = "<table>";
$display_string .= "<tr>";
$display_string .= "<th>Name</th>";
$display_string .= "<th>Age</th>";
$display_string .= "<th>Sex</th>";
$display_string .= "<th>WPM</th>";
$display_string .= "</tr>";

// Insert a new row in the table for each person returned
while($row = mysql_fetch_array($qry_result)){
    $display_string .= "<tr>";
    $display_string .= "<td>$row[ae_name]</td>";
    $display_string .= "<td>$row[ae_age]</td>";
    $display_string .= "<td>$row[ae_sex]</td>";
    $display_string .= "<td>$row[ae_wpm]</td>";
    $display_string .= "</tr>";
}
echo "Query: " . $query . "<br />";
$display_string .= "</table>";
echo $display_string;
?>
-- http://www.w3programmers.com/simple-crud-php-sqlite-database/
--*/

--no need to go mad on var names...:
--for i=1 to 6 do
--  printf(1,"%d chars:%,d\n",{i,26*power(36,i-1)}) -- a-z,0-9
--end for
--1 chars:26
--2 chars:936
--3 chars:33,696
--4 chars:1,213,056
--5 chars:43,670,016
--6 chars:1,572,120,576
--for i=1 to 6 do
--  printf(1,"%d chars:%,d\n",{i,52*power(62,i-1)}) -- a-z,A-Z,0-9
--end for
--1 chars:52
--2 chars:3,224
--3 chars:199,888
--4 chars:12,393,056
--5 chars:768,369,472
--6 chars:47,638,907,264
-- and check with 7zip and/or http://www.gidnetwork.com/tools/gzip-test.php if it saves anything (Douglas Crockford says not)

-- Note that C support is a bit of an afterthought, more of a "text processing translation assistant" and
--  never meant to be an "ok, done, now throw that at a compiler" kind of thing (which /is/ the intention
--  for the JavaScript part). The C part is (hopefully) just a timesaver in an otherwise manual process.

-- Of necessity, the tokeniser/parser of p2js is very generic and therefore may blithely permit certain
-- blatent syntax errors that the desktop compiler catches immediately.. (Niggles)

-- Only lowercase html tags are supported [DEV?].

--//    console.log("one");
--/!*
--  console.log("two");
--// nope, js does not support nested comments...
--  /x*
--  console.log("three");
--  *x/
--  console.log("four");
--*!/
--//    console.log("five");
--
--1) This must be able to parse pGUI.js... (and the four examples I've already got...)
--      (although we're only really interested in collating the store_attr() calls)
-- Note: Phix and js allow nested comments, html and css do not [CHECKED, TRUE]

--view-source:file:///E:/downloads/misc/js/vanillajs/making-a-simple-programming-language-pl-0-in-javascript/dist/index.html    [AST-side is drivel]
-- https://codepen.io/Nondera/pen/qLVNwQ (plain excel, no guts, no resize, but looks fair)
--<input type="range">
--https://shoelace.style/
--https://ishadeed.com/article/finding-the-root-cause/ (hmm)
--  I only added "vertical-align: top;" and the issue is fixed instantly.
--
-->>
--  title: max 56 characters
--  Define keywords for search engines: <meta name="keywords" content="HTML, CSS, JavaScript">
--  Define a description of your web page: <meta name="description" content="Free Web tutorials">
--  Define the author of a page: <meta name="author" content="John Doe">           
--   <meta name = "revised" content = "Tutorialspoint, 3/7/2014" />
--   <meta http-equiv = "cookie" content = "userid = xyz; expires = Wednesday, 08-Aug-15 23:59:59 GMT;" />
--   <meta http-equiv = "Content-Type" content = "text/html; charset = UTF-8" /> -- **DEPRECATED**, use this instead:
--   <meta charset='utf-8'>                                                     [YEP]
--   <meta name="viewport" content="width=device-width, initial-scale=1">       [YEP]
--   https://www.webdesignerdepot.com/2019/12/metatags-101-a-simple-guide-for-designers/ [done]
--   <meta name="robots" content="noindex, nofollow">
--   <meta name="robots" content="index, follow">       (default)
--   <meta name="robots" content="noindex, follow">
--   <meta name="robots" content="index, nofollow">
--   <html lang="en"> (instead of <meta name="Content-Language" content="english">) [YEP]
--   <meta name="generator" content="http://phix.x10.mx">
--   <meta property="og:site_name" content="The Official SpyFu Blog" />
--   <meta property="og:type" content="article" />
--   <meta property="og:title" content="What is Search Intent and Why Does it Matter?" />
--   <meta property="og:title" content="The best site">
--   <meta property="og:image" content="link_to_image">
--   <meta property="og:description" content="description goes here">

--
--work area: E:\downloads\misc\js\pwa       -- (all runnables/tests live here)
--           E:\downloads\misc\js\pwa\js    -- (read-only, not meant to be run)
--           E:\downloads\misc\js\pwa\phix  -- (read-only, not meant to be run, but should)
-- to become: Phix\pwa      -- (all editable/runnable/test/temps live here)
--            Phix\pwa\js   -- (read-only, not meant to be run)
--            Phix\pwa\phix -- (read-only, not meant to be run, but should)
--
--      The /js and /phix directories are for final/backup copies to be used
--      primarily for regression and unit testing, specifically can it still
--      create one from the other perfectly? Copies of every file in /js and 
--      /phix may also exist in pwa, however the latter can be overwritten.
--
--  "p2js" opens a gui [with a proper history and most recent as defaults,
--                     plus js/serve/run/profile/tree/edit etc options.]
--  "p2js test[.exw]" behaves just like "pw test" except the source is first parsed for web-compatibility.
--  "p2js -js [-run] test[.exw]" creates test.js (useful for packaging, etc) [and opens it in the browser]
--  "p2js [-js] -server test[.exw]" creates/serves test.js to localhost:8080
--                                 (with live updates [if at all possible,
--                                  and all sub-includes auto-monitored.])
--  "p2js (--|-server)" resumes/restarts a crashed or edited server.
--
--DOC: puts,printf: pwa/p2js: fn=1 appends to the end of the document.
--                            fn=2 prepends to the start of the document (NB puts(2,"1"); puts(2,"2"); shows "21", //**not**// "12"!)
--                            all other values of fn are invalid under pwa/p2js.
--
-- IupDialog: pwa/p2js: The only currently supported/properly tested attributes are: EXPAND...
-- IupLabel: pwa/p2js: The only currently supported/properly tested attributes are: EXPAND...
-- ALIGNMENT: pwa/p2js: The only currently supported/properly tested attributes are: YES, HORIZONTAL, VERTICAL...
-- *** use class="pwsp2js" as per IupLabel. (note this currently overrides link/hover/visited...)
--
-- Mnemonics: replace &x with <u>x</u>; save {ih,x} in a table somewhere; google for examples.
--
-- SUG: Run this <a href="http://phix.x10.mx/runrc.htm?src='xxx'">online</a>:
--      fetch https://www.rosettacode.org/wiki/xxx and extract the <lang Phix>..</lang> part(s?)
--      (or runrc.htm could understand xxx as an internal lookup...)
--      then codepen-style phix [libs] result it...
--      erm, get something similar working on the desktop first... [there's a task to be submitted there]
--      crib one of the existing rc-fetch tasks, and list online/not online (GUI with totals), pdemo-style.
--      extra credit: record how many times each was run [and construct a drop-down/pop-up listview/search doobrie [NO: pdemo-style]].

--/*
<!DOCTYPE html>
<html>
<body>

<p>Press a key on the keyboard in the input field to find out if the ALT key was pressed or not.</p>

<input type="text" onkeydown="isKeyPressed(event)">

<p id="demo"></p>

<scr!ipt>
function isKeyPressed(event) {
  let x = document.getElementById("demo");
  if (event.altKey) {
    x.innerHTML = "The ALT key was pressed!";
  } else {
    x.innerHTML = "The ALT key was NOT pressed!";
  }
}
</scr!ipt>

</body>
</html>

$(function()
{
    //Flag to check if another key was pressed with alt
    let vAnotherKeyWasPressed = false;      // PL we might want null/char instead
    //ALT keycode const
    const ALT_CODE = 18;

    //When some key is pressed
    $(window).keydown(function(event)
    {
        //Identifies the key
        let vKey = event.keyCode ? event.keyCode : event.which ? event.which : event.charCode;
        //The last key pressed is alt or not? 
        vAnotherKeyWasPressed = vKey != ALT_CODE;
    });

    //When some key is left
    $(window).keyup(function(event)
    {
        //Identifies the key
        let vKey = event.keyCode ? event.keyCode : event.which ? event.which : event.charCode;

        //If the key left is ALT and no other key is pressed at the same time...
        if (!vAnotherKeyWasPressed && vKey == ALT_CODE)
        {
            //Focus the menu
            $('#myMenu').focus();
            //Stop the events for the key to avoid windows set the focus to the browser toolbar 
            return false;
        }
    });
});
http://gcctech.org/csc/javascript/javascript_keycodes.htm
https://www.w3schools.com/JSREF/obj_keyboardevent.asp
altKey/charCode/code/ctrlKey/getModifierState()/key/keyCode/shiftKey/which...
onkeydown/onkeypress/onkeyup.

<scr!ipt type="text/javascript">
document.onkeydown = clickRadio;

function clickRadio(e) {

--  if (window.event) {
--      var keyCode = window.event.keyCode; // IE
--  } else {
        let keyCode = e.which;
--  }

    if (e.altKey && (keyCode == 65 || keyCode == 97 || keyCode == 78 || keyCode == 110)){
        setRadioButton(keyCode);
    }
}
</scr!ipt>
window.addEventListener('keydown', function(e) {
  if (e.altKey == true && e.keyCode == 78)
    console.log('Alt + N'); 
});

--/?? [test this theory] Note that pGUI.e associates a mnemonic label with the following
--//  control in the layout hierarchy, whereas pGUI.js associates it with the next defined
--//  element (at runtime) instead. Often, of course, they would be the same, except for 
--//  say lbl1, lbl2, txt1, txt2 (==> reorder source as lbl1, txt1, lbl2, txt2 [with =s,
--//  by which I mean "Ihandle lbl1, lbl2, txt1, txt2" is unimportant, it is the order of
--//  IupLabel(), IupText(), IupLabel(), IupText() as actually executed at runtime.]).
--//  In other words an IupText inherits any outstanding key association at declaration.
--//  Likewise in pGUI.js an IupDialog inherits all outstanding mnemonics (aka Alt keys)
--//  when it is defined, whereas pGUI.e does so from the child argument and MENU.

It is not the intention to make pwa/p2js execute legacy code, but rather instead to allow
new desktop/browser gui development in tandem, with appropriate warnings when you try to
run something on the former which won't work on the latter. Said warnings can of course
be used to lick some old legacy code into shape, hopefully. Equally, pwa/p2js retains a
"desktop first" attitude. If you get it to work in the browser first, no problem, but it
assumes that a developer would much prefer to rely on the existing debug and diagnostic
capabilites available during desktop development over the rather more muted experience
of syntax/typo/runtime errors occuring in the browser with an initially hidden console.
Type checks are strictly desktop-only, and trace, ex.err, and profile quite different.

Early adopters should also take note of the sheer number of attributes, elements, and
containers that pGUI.e supports, each of which must be individually implemented, and
hence not expect too much from pGUI.js too soon. Check the existing examples first.
It remains unlikely that everything in pGUI.e will be supported in pGUI.js, ever.
--*/

--
-- Syntax colouring examples:
--      IupButton() -- normal (not that all such are yet supported by p2js)
--      IupExecute() -- desktop only
--      IupThread() -- neither desktop nor p2js
--
-- STEP 1: write some working examples by hand
-- STEP 2: lexer/ttree/parser/treeview & output the *same* text
--          (my plans to simplify comment handling go awol if this is the new reindenter)
--          (the treeview should be fully expand-on-demand, aka delayed load, btw)
--          lexer: job is just to spit out start/end etc.
--          ttree: job is (text-only) unique id, with a single idx local store.
--          parser: tree contains current position/indent info, which reindent can later tweak.
-- STEP 3: cross-compile & verify the examples
--          reindent can add/set some flags for the minimal editing stuff[?]
--
-- OK,  1: js strings are immutable.
--      2: Phix sequence {} notation needs to become [].
--      3: Phix 1-based indexes need to become 0-based. (map to function calls?)
--      1+2+3 => "s[i] := e" --> s = replace(s,i,e), other "s[i]" --> "subscript(s,i)". (in phix-web.js)
--
--  The basic idea is to support a subset of Phix and a subset of IUP, and transpile to HTML/JavaScript.
--  Use "if platform()=WEB / else" or similar to control any fiddly/incompatible bits.
--  The pwa/p2js.exw application itself can read local files etc, however the web version cannot ("").
--  Outwardly pwa/p2js.exw is a gui front-end to the transpiler/interpreter, internally it performs a 
--  bunch of checks to keep your desktop development process on-track, making sure you do not start to
--  use things that later cannot be transpiled (such as #ilASM{}, outside of a platform() test anyway).
--
-- *** should work on Phix, JavaScript, and C ***
-- *** should work from clipboard ***
-- *** should have -test [infile outfile] command-line handling *** (not found -> create? prompt, otherwise never overwrite)
--
-- We need: fast source -> AST, integer-only, using a ttree directly.
-- It does not need to load numbers, a start/end/ttidx would suffice (maybe).
--  - I should find permitted js number formats, though
-- It should be possible to manipulate the AST, eg to perform CSE (common subexpression elimination).
--XXXX It does not help one iota to make JavaScript arrays that are zero-based... so stick with 1-based. -- UTTER BOLLOCKS: str[0] is the first character! (erm, no, it's a string!!!)
-- Note that Phix's 1-based [idx] is transpiler to js 0-based [idx-1] (where "idx" is any expression).
-- let a = 'Hi there!';  // using single quotes
--  document.write(typeof(a.charAt(1)) + "<br>");       -- string
--  document.write(typeof(a.charCodeAt(1)) + "<br>");   -- number
--  document.write(a.charAt(1) + "<br>");               -- i
--  document.write(a.charCodeAt(1) + "<br>");           -- 105
-- hmm: https://rosettacode.org/wiki/Compiler/lexical_analyzer
--      C:\Program Files (x86)\Phix\demo\rosetta\Compiler\lex.exw
--      https://rosettacode.org/wiki/Compiler/lexical_analyzer#JavaScript ( file:E:\downloads\misc\js\lexer.js )
--Searching for: include
-- Files scanned 27, Directories scanned 1, Lines 5510
--C:\Program Files (x86)\Phix\demo\rosetta\Compiler\cgen.e:8 include parse.e
--C:\Program Files (x86)\Phix\demo\rosetta\Compiler\cgen.e:317 include builtins/VM/puts1.e -- low-level console i/o routines
--C:\Program Files (x86)\Phix\demo\rosetta\Compiler\cgen.exw:8 include cgen.e
--C:\Program Files (x86)\Phix\demo\rosetta\Compiler\interp.exw:5 include parse.e
--C:\Program Files (x86)\Phix\demo\rosetta\Compiler\lex.e:8 include core.e
--C:\Program Files (x86)\Phix\demo\rosetta\Compiler\lex.exw:12 include lex.e
--C:\Program Files (x86)\Phix\demo\rosetta\Compiler\parse.e:8 include lex.e
--C:\Program Files (x86)\Phix\demo\rosetta\Compiler\parse.exw:5 include parse.e
--C:\Program Files (x86)\Phix\demo\rosetta\Compiler\vm.exw:23 include cgen.e
--      https://rosettacode.org/wiki/GUI_component_interaction (below)
--      https://rosettacode.org/wiki/GUI_enabling/disabling_of_controls
--      https://rosettacode.org/wiki/GUI/Maximum_window_dimensions
--      https://rosettacode.org/wiki/Hello_world/Graphical
--      https://rosettacode.org/wiki/Parsing/RPN_calculator_algorithm
--      https://rosettacode.org/wiki/Parsing/RPN_to_infix_conversion
--      https://rosettacode.org/wiki/Parsing/Shunting-yard_algorithm
--      https://github.com/alexei/sprintf.js ( file:E:\downloads\misc\js\sprintf.js ) [DONE]
--
--  https://rosettacode.org/wiki/GUI_component_interaction#Phix (no js entry)
-- (gotta be able to do better than http://lambdaway.free.fr/lambdawalks/?view=interaction - no-one else offers an online demo...)
--/*
include pGUI.e
 
Ihandle txt, increment, random, hbx, vbx, dlg
 
function action_cb(Ihandle /!*ih*!/, integer ch)
    if not find(ch,"0123456789-") then return IUP_IGNORE end if
    return IUP_CONTINUE
end function
 
function increment_cb(Ihandle /!*ih*!/)
    integer v = IupGetInt(txt,"VALUE")+1
    IupSetInt(txt,"VALUE",v)
    return IUP_CONTINUE
end function
 
function random_cb(Ihandle /!*ih*!/)
    if IupAlarm("Confirm","Replace wth random value?","Yes","No")=1 then
        IupSetInt(txt,"VALUE",rand(1000))
    end if
    return IUP_CONTINUE
end function
 
IupOpen()
txt = IupText(Icallback("action_cb"),"EXPAND=YES")
increment = IupButton("increment",Icallback("increment_cb"))
random = IupButton("random",Icallback("random_cb"))
hbx = IupHbox({increment,random},"MARGIN=0x10, GAP=20")
vbx = IupVbox({txt,hbx},"MARGIN=40x20")
dlg = IupDialog(vbx)
IupCloseOnEscape(dlg)
IupShow(dlg)
IupMainLoop()
IupClose()
--*/

--other (from pdemo):
-- call(/pass!) by reference
-- ipcdemo
-- named pipes
-- raycast
-- progress window
-- treeview drag and drop
-- aaline
-- gears
-- 7 guis
-- teselation
-- web browser
--rc:
--  2048 (rc/js uses p5.js...)
--  https://rosettacode.org/wiki/Animation#JavaScript_.2B_HTML - demo\rosetta\Animation.exw
--  https://rosettacode.org/wiki/Animate_a_pendulum#JavaScript - demo\rosetta\animate_pendulum2.exw (hmm)
--  https://rosettacode.org/wiki/Archimedean_spiral#JavaScript
--  https://rosettacode.org/wiki/Barnsley_fern#JavaScript       [DONE!]
--  demo\rosetta\Chaos_game.exw
--  demo\rosetta\Conways_Game_of_Life.exw (maybe)
--  demo\rosetta\FractalTree.exw
--  demo\rosetta\Greyscale_bars.exw
--  https://rosettacode.org/wiki/Greyscale_bars/Display#JavaScript
--  demo\rosetta\ImageNoise.exw
--  demo\rosetta\Mouse_position.exw  https://rosettacode.org/wiki/Mouse_position#JavaScript
--  file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/OpenGL.html  demo\pGUI\triangle.exw
--  https://rosettacode.org/wiki/Plasma_effect#JavaScript demo\rosetta\plasma.exw
--  demo\rosetta\Playing_cards.exw (no real js equiv, sadly it's only black-and-white...)
--  demo\rosetta\Polyspiral.exw (== PolyAnim.html, apart from speed + colours)
--  demo\rosetta\PythagorasTree.exw
--  demo\rosetta\SierpinskyTriangle.exw (not quite the same)
--  demo\rosetta\Simple_window.exw (no js equiv as yet)
--  demo\rosetta\Superellipse.exw (meh)
--  demo\rosetta\Sutherland_Hodgman_polygon_clipping.exw (<==nice one)
--  https://rosettacode.org/wiki/System_time#Phix (advanced, needs ability to compile datetime.e in full, no real js equiv as yet)
--  https://rosettacode.org/wiki/Time_a_function#JavaScript (maybe/idea for a time() function... see phix_web.js)
--  https://rosettacode.org/wiki/Tokenize_a_string_with_escaping#JavaScript (just uses document.write()...)
--  https://rosettacode.org/mw/index.php?title=Colour_bars/Display#Phix (maybe, demo\rosetta\Colour_bars.exw )

--C:\Program Files (x86)\Phix\demo\libxlsxwriter\js\
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/pendulum_canvas.html
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/ArchiSpiral.html
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/BarnsleyFern.html
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/CreateHTMLtable.html
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/chaos.html
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/Conway.html (maybe)
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/DrawOutlineTable.html (UGH: needs work, wikitable->html)
-- C:\Program Files (x86)\Phix\demo\libxlsxwriter\js\adbc.html (do-able, console? - is that actually the trick I've been looking for?!!!)
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/FractalTree.html
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/Greyscale_bars.html
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/Image_noise.html
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/mint.html http://phix.x10.mx/mint.html (RCPOP==>const?, exw rqd)
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/OpenGL.html
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/plasma.html
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/PolyAnim.html
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/PythagorasTree.html
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/SierpinskiTriangle.html
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/Superelipse.html
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/Sutherland_Hodgman_polygon_clipping.html
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/VisualizeTree.html [??]

-- https://www.codeproject.com/Articles/345888/How-to-write-a-simple-interpreter-in-JavaScript?msg=4649602#xx4649602xx
-- see file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/Calculator/Calculator.html (good, but not my preferred parsing method...)
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/FlowSharpWeb/flowSharpWeb.html -- implement via pGUI..//PhixLogo...
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/jsFormGen/formgen/jsFormGen.html
--  - basis for IupLabel, IupText (+IupMultiLine), IupCheckBox, I mean IupToggle, IupButton, IupList (DROPDOWN), IupCalendar[?], IupDatePick, IupRadio,
--              IupValuator,
-- file:///C:/Program%20Files%20(x86)/Phix/demo/libxlsxwriter/js/phix-web/tabindex.html --?? (maybe/unlikely)

--E:\downloads\misc\js\
--  rc/Animation.html (hmm, not so great...)
--  rc/Animation.svg.html (broken)
--  file:///E:/downloads/misc/js/1-Line%20Layouts.html
--  file:///E:/downloads/misc/js/calculator-master/index.html (meh - but the layout (or rather concept) in a window, we should do that...)
--  file:///E:/downloads/misc/js/except.html (so it /is/ doable as string, only)
--  file:///E:/downloads/misc/js/Download/rc/js/Calculator/Calculator.html (but I think the one above is now the master...)
--  E:\downloads\misc\js\terminal-window\ :
--      (perhaps puts(1,xxx) ==> document.write(xxx) is all we need/should be the default... "format console", however...)
--      file:///E:/downloads/misc/js/terminal-window/linux-terminal/dist/index.html (gets input and scroll right... ["clear" is the only working command])
--      file:///E:/downloads/misc/js/terminal-window/site-terminal/dist/index.html ("", no '&', expands width, no cursor or editing facilities...)
--      Xfile:///E:/downloads/misc/js/terminal-window/terminal2/terminal/dist/index.html (as 1, but help [EEK, no, uses jquery!] )
--      file:///E:/downloads/misc/js/terminal-window/terminal-js/dist/index.html (maybe, weaker, flicker, drag a bit suspect)
--  E:\downloads\misc\js\treeview\ :
--      file:///E:/downloads/misc/js/treeview/a-css-treeview-control/dist/index.html (need to separate out click on expand and click on node, no lines)
--      file:///E:/downloads/misc/js/treeview/react-vertualwindow/dist/index.html (ugh, react obfuscated... [but might be debuggable?] )
--      file:///E:/downloads/misc/js/treeview/select-tag-dialog/dist/index.html (select/expand almost there) [odd effect commenting out this.onDblClick = onDblClick...] [2nd best?]
--      file:///E:/downloads/misc/js/treeview/treeview-static/dist/index.html (pretty, but rubbish)
--      file:///E:/downloads/misc/js/treeview/usmle-competencies/dist/index.html (jQuery, but easily the best so far [debuggable?])
--      file:///E:/downloads/misc/js/treeview/  -- hey, if you just open a directory, opera/chromium creates a nice fake index.htm for you....
--                                              -- (copying it will obvs. effectively enact a dynamic -> static transition..[?] which shd actually be just what we want...)
--                                              -- (no shit, it is properly column-sortable, with drag and drop too... [albeit more of a listview])
--                                              -- (one such now copied and tweaked [root], see E:\downloads\misc\js\native.html [nb links are misleading!!])
--  E:\downloads\misc\js\uilang\ :
--      file:///E:/downloads/misc/js/uilang/examples/accordion/accordion/index.html (maybe, no pGUI equivalent)
--      file:///E:/downloads/misc/js/uilang/examples/exploremenu/explore.html               ("")
--      file:///E:/downloads/misc/js/uilang/examples/gallery/gallery.html                   ("")
--      file:///E:/downloads/misc/js/uilang/examples/hamburger/hamburger.html               ("")
--      file:///E:/downloads/misc/js/uilang/examples/keynote/keynote.html                   ("") (aka slideshow)
--      file:///E:/downloads/misc/js/uilang/examples/notification/notification/index.html   ("")
--      file:///E:/downloads/misc/js/uilang/examples/overlay/overlay/index.html     (maybe, aka button & popup)
--      file:///E:/downloads/misc/js/uilang/examples/panels/panels.html             (not really)
--      file:///E:/downloads/misc/js/uilang/examples/popover/popover/index.html     (not really, menu bar)
--      file:///E:/downloads/misc/js/uilang/examples/switch/switch/index.html       (maybe, aka toggle)
--      file:///E:/downloads/misc/js/uilang/examples/tabs/tabs/index.html           (good, see also tabs-with-vanillajs below) [now de-uilang'd]
--  E:\downloads\misc\js\vanillajs\ :
--      file:///E:/downloads/misc/js/vanillajs/svg.html (just the cross?)
--      file:///E:/downloads/misc/js/vanillajs/bytesize-icon-sheet/dist/index.html ("")
--      file:///E:/downloads/misc/js/vanillajs/single-line-svg-icons/dist/index.html ("")
--      file:///E:/downloads/misc/js/vanillajs/form-validation-vanillajs/dist/index.html (maybe)
--      file:///E:/downloads/misc/js/vanillajs/login-signup-form/dist/index.html (not really [bit fancy but we should be able to do something similar but plainer])
--      file:///E:/downloads/misc/js/vanillajs/magic-table/dist/index.html (maybe, sortable listview)
--      file:///E:/downloads/misc/js/vanillajs/sortable-table-pure-js/dist/index.html ("")
--      file:///E:/downloads/misc/js/vanillajs/vanillajs-crud-application/dist/index.html ("", with add and delete buttons)
--      file:///E:/downloads/misc/js/vanillajs/vanillajs-sortable-table/dist/index.html ("", but with json-load instead)
--      file:///E:/downloads/misc/js/vanillajs/progress-bar-vanillajs/dist/index.html (progressbar/gauge)
--      file:///E:/downloads/misc/js/vanillajs/pure-css-date-picker/dist/index.html (good)
--      file:///E:/downloads/misc/js/vanillajs/pure-css-delightful-checkbox-animation/dist/index.html (good, but uses jquery/modernizr/prefixfree libs)
--      file:///E:/downloads/misc/js/vanillajs/pure-css-material-components-showcase/dist/index.html (good, but pure css/may be on the heavy side)
--      file:///E:/downloads/misc/js/vanillajs/pwa-vanillajs-master/index.html (recipies, maybe, if we can get pGUI to do that flow thing)
--      file:///E:/downloads/misc/js/vanillajs/tabs-with-vanillajs/dist/index.html (good)
--      file:///E:/downloads/misc/js/vanillajs/ui-statistic-pop-out-css/dist/index.html (maybe, if we can get pGUI to hover-zoom)
--      file:///E:/downloads/misc/js/vanillajs/vanillajs-copy-text-to-clipboard/dist/index.html (good, not really planned but why not)
--      file:///E:/downloads/misc/js/vanillajs/vanillajs-resizable-panes/dist/index.html (splitter?)
--      file:///E:/downloads/misc/js/vanillajs/vanillajs-todolist/dist/index.html (good, best to-do yet seen, but no permanent save)
--      E:\downloads\misc\js\vanillajs\10print\10print.htm - cdCanvasBegin???
--      E:\downloads\misc\js\vanillajs\dotchain\dotchain.htm    ""
--      E:\downloads\misc\js\vanillajs\click\click.htm - 7Guis circle_drawer!!!!
-- C:\Program Files (x86)\Phix\demo\arwendemo:
--      clip.exw
--      demo_controls.exw
--      demo_curve_fit.exw
--      demo_title.exw
--      demo_treeview.exw [?]
--      scowel.exw
--      demo_xpm.exw
--      GraphR.exw
-- C:\Program Files (x86)\Phix\demo\rosetta\7guis:
--      Counter.exw
--      Converter.exw
--      Booker.exw
--      Timer.exw
--      CRUD.exw
--      CircleDraw.exw
--      Cells.exw
-- And try to convert these from C to Phix... (from http://webserver2.tecgraf.puc-rio.br/iup/en/7gui/7gui.html )
-- C:\Program Files (x86)\Phix\demo\rosetta\7guis\IUP\counter.c
-- C:\Program Files (x86)\Phix\demo\rosetta\7guis\IUP\temperature_converter.c
-- C:\Program Files (x86)\Phix\demo\rosetta\7guis\IUP\flight_booker.c
-- C:\Program Files (x86)\Phix\demo\rosetta\7guis\IUP\timer.c
-- C:\Program Files (x86)\Phix\demo\rosetta\7guis\IUP\crud.c
-- C:\Program Files (x86)\Phix\demo\rosetta\7guis\IUP\circle_drawer.c
-- C:\Program Files (x86)\Phix\demo\rosetta\7guis\IUP\cells.c
-- maybe: demo\pGUI\iup_layoutdlg.e <-> .c (newer version?)
-- from https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API
--      From the other way: something easy in js we can easily mimic in pGUI?:
--      <canvas id="canvas"></canvas>
--      const canvas = document.getElementById('canvas');
--      const ctx = canvas.getContext('2d');
--
--      ctx.fillStyle = 'green';
--      ctx.fillRect(10, 10, 150, 100);
--
--  Aside: While manually-written js uses getElementById() alot, in pGUI.e 
--                                                   (and therefore pGUI.js) [[ <<== HEY! ]]
--         we use (eg) Ihandle|let dlg = IupDialog(); instead... (just sayin)
--
-- possibly useful checklist: https://en.wikipedia.org/wiki/Graphical_widget
-- maybe: E:\downloads\misc\js\animatedPendulumElm.htm (9,993 lines anyway)

--/*
--SUG:
constant LANG_SET  = 0b0001,
         LANG_ANY  = 0b1110,    -- phix or js or c
         LANG_PHIX = 0b0011,
         LANG_JSC  = 0b1100,    -- js or c
         LANG_JS   = 0b0101,
         LANG_C    = 0b1001

sequence tokens = {},
         tflags = {}

procedure add_token(string token, integer flags)
-- erm, use one of them there ternary tree doobries..
    tokens = append(tokens,token)
    tflags = append(tflags,flags)
end procedure

add_token("function",LANG_ANY)
add_token("if",LANG_ANY)
add_token("then",LANG_PHIX)
add_token("{",LANG_ANY)     -- (LANG_JSC in some contexts)
add_token("}",LANG_ANY)
add_token("(",LANG_ANY)
add_token(")",LANG_ANY)
add_token("[",LANG_ANY)
add_token("]",LANG_ANY)
add_token("--",LANG_PHIX)
add_token("--/"&"*",LANG_PHIX)
add_token("//",LANG_ANY)
add_token("/"&"*",LANG_ANY)
add_token("=",LANG_ANY)
add_token("==",LANG_ANY)
add_token(":=",LANG_PHIX)
add_token("..",LANG_PHIX)

step 1: get **ONE** program tht is //believably// translatable! [DONE, in fact I got 2]
step 2: tokeniser -> just list and show counts...

-- Note that comments may not be used mid-factor, they can only occur between statements and before/after a comma operator. [[BLUFF!!]]
-- (This rule may be relaxed/extended if (and only if) suitable compelling examples arise.)
-- [erm, as noted in pwa.exw: my plans to simplify comment handling go awol if this is the new reindenter, plus we
--  absolutely *MUST* support things like "xxx_cb(Ihande /!*ih*!/, ...)"]
-- Note that IUP.js is written to imitate the Phix/pGUI.e/C api and therefore may not contain all the usual js niceities,
-- for instance IupDialog(ih,"SIZE=200x200") is fine, but (as yet) IupDialog(ih,{SIZE:"200x200"}) is not.
-- (it may be better off named phix-web.js rather than IUP.js)

Big list of unsupported things: open, seek, where, [puts], getc, gets, get_text, get_key, [wait_key], dir, current_dir,
chdir, allow_break, check_break, file_exists..join_path, command_line, getenv(?), system[_exec], abort?, include_paths,
clear_screen, [get_]position, video_config, scrfoll, wrap, text_color, bk_color, save_bitmap, cursor, get/put_screen_char,
save/display_text_image, free_console, allocate, call, delete_routine[?], peek, poke, [un]lock_file, finally, 
mem_copy, mem_set, [un]register_block, open_dll, get_proc_address, [define_]c_func/proc/var, instance, task_create,
init_cs, create_thread, canonical_path, prompt_number, prompt_string, get_bytes, read_lines, read_file, any_key, 
machine_func/proc, cffi, database, ipc, libcurl[?], LiteZip, mpfr/gmp[?], pSQLite[?], sockets, ...

try/catch: can only throw string, and catch e can only use e[E_USER], as a string.

Maybe, or (special) comments:
Hungarian notation:     Type:   Examples/notable exceptions:
a                       atom
b               bool/boolean    bFlag
c                    integer    ch
d                       atom    dwLength, delta
h                       atom    hWnd
i                    integer
l                    integer    lSize
o                     object
p                       atom    pAddr
q                   sequence    qSet
s                     string    sName
If a variable does not begin as above, it is prefixed by a_/i_/q_/s_/o_ - and/or those prefixes are/may be automatically removed.
Note that user-defined types are not suported in Phix->Js, or restored in Js->Phix.
Note that Js->Phix is not fully supported, but allows web-page-only code (not subsequently altered) to be run on the desktop.

The attribute "class" (lowercase) is ignored on the desktop, but impacts on generated css [??] [ditto "style"?]
pGUI has been modified to permit (selected?) lowercase attributes? (for "")
IupButton <=> createElement(`button`)?? (etc) [better: function IupButton(...) in IUP.js?]
IupSetAttribute <=> setAttribute??              [""]
IupAppend <=> appendChild??                     [""]
Callbacks are translated to addEventListener/

--*/

--/*
latest rework: [js version DONE, this may [yet] be useful right here...]
--with trace
string text

function iAttribCapture(integer asdx, lim, string delims)
    while asdx<=lim and not find(text[asdx],delims) do
        asdx += 1
    end while
    return asdx
end function

function iAttribSkipComment(integer asdx, lim)
    while asdx<=lim do
        if text[asdx]='\n' then exit end if
        asdx += 1
    end while
    return asdx
end function

enum TK_END, TK_SET, TK_COMMA, TK_NAME

function iAttribToken(integer asdx, lim)
    integer start = asdx
    while 1 do
        if asdx>lim then return {TK_END,lim+1,lim+1} end if
        integer c = text[asdx]
        asdx += 1
--      if find(c,"#") then
--?9/0
--          start = iAttribSkipComment(start, lim)
--      els
        if find(c," \t\n\r") then
            start = asdx
        else
            if c='=' then
                return {TK_SET,start,asdx}
            elsif c=',' then
                return {TK_COMMA,start,asdx}
            elsif c='"' then
                asdx = iAttribCapture(start+1,lim,`"`)	-- string
                asdx += 1
            else
                asdx = iAttribCapture(start,lim,"=, \t\n\r")
            end if
            return {TK_NAME,start,asdx}
        end if
    end while
end function

function parse_attributes(integer asdx, lim)
sequence names = {}, vals = {}
string name = "", val
integer state = 'a',    -- get attribute
        tk, start

    if lim>asdx then
        if find('=',text,asdx)=0 then ?9/0 end if
    end if

    while 1 do
        {tk,start,asdx} = iAttribToken(asdx,lim)
        switch tk do
            case TK_END,
                 TK_COMMA:
                if length(name) then
                    names  = append(names,name)
                    vals = append(vals,val)
                end if
                if tk=TK_END then exit end if
--              name = ""
--              val = ""
                state = 'a'

            case TK_SET:
                state = 'v' -- get value

            case TK_NAME:
                -- (you /could/ do this on idx, but is
                --  {start,asdx-1} really any better?)
                if state=='a' then
                    name = text[start..asdx-1]
                else
                    val = text[start..asdx-1]
                end if

        end switch
    end while
    return {names,vals}
end function

procedure show(sequence r)
    ?r
end procedure

text = """
IupSetAttributes(dlg,"EXPAND=YES, ALIGNMENT=ACENTER")
IupSetAttributes(dlg,`TITLE="Hello", MINSIZE=225x75`)
"""
constant s1 = find('"',text)+1,
         e1 = find('"',text,s1)-1,
         s2 = find('`',text)+1,
         e2 = find('`',text,s2)-1
show(parse_attributes(s1,e1))
show(parse_attributes(s2,e2))
--?parse_attributes("EXPAND=YES, ALIGNMENT=ACENTER")
--?parse_attributes(`TITLE="Hello", MINSIZE=225x75`)
--{{"EXPAND","ALIGNMENT"},{"YES","ACENTER"}}
--{{"TITLE","MINSIZE"},{"Hello","225x75"}}
--"done"

from https://www.rosettacode.org/wiki/Tokenize_a_string_with_escaping#JavaScript
function tokenize(s, esc, sep) {
    let a = [],
        t = '',
        e = s.length;
    for (let i=0; i<e; i+=1) {
        let c = s.charAt(i)
        if (c == esc) t+=s.charAt(++i)
        else if (c != sep) t+=c
        else a.push(t), t=''            
    }
    a.push(t)
    return a
}
 
let s = 'one^|uno||three^^^^|four^^^|^cuatro|'
document.write(s, '<br>')       
for (let a=tokenize(s,'^','|'), i=0; i<a.length; i+=1) document.write(i, ': ', a[i], '<br>')

--*/

--https://rosettacode.org/wiki/GUI_component_interaction#Phix (no js entry)
--/*
include pGUI.e
 
Ihandle txt, increment, random, hbx, vbx, dlg
 
function action_cb(Ihandle /!*ih*!/, integer ch)
    if not find(ch,"0123456789-") then return IUP_IGNORE end if
    return IUP_CONTINUE
end function
 
function increment_cb(Ihandle /!*ih*!/)
    integer v = IupGetInt(txt,"VALUE")+1
    IupSetInt(txt,"VALUE",v)
    return IUP_CONTINUE
end function
 
function random_cb(Ihandle /!*ih*!/)
    if IupAlarm("Confirm","Replace wth random value?","Yes","No")=1 then
        IupSetInt(txt,"VALUE",rand(1000))
    end if
    return IUP_CONTINUE
end function
 
IupOpen()
txt = IupText(Icallback("action_cb"),"EXPAND=YES")
increment = IupButton("increment",Icallback("increment_cb"))
random = IupButton("random",Icallback("random_cb"))
hbx = IupHbox({increment,random},"MARGIN=0x10, GAP=20")
vbx = IupVbox({txt,hbx},"MARGIN=40x20")
dlg = IupDialog(vbx)
IupCloseOnEscape(dlg)
IupShow(dlg)
IupMainLoop()
IupClose()
--*/
--https://rosettacode.org/wiki/GUI_enabling/disabling_of_controls#Phix (no js entry)
-- (not brill...)
/*
include pGUI.e
 
Ihandle txt, inc, dec, hbx, vbx, dlg
 
function activate(integer v)
    IupSetInt(txt,"VALUE",v)
    IupSetAttribute(inc,"ACTIVE",iff(v<10,"YES":"NO"))
    IupSetAttribute(dec,"ACTIVE",iff(v>0,"YES":"NO"))
    IupSetAttribute(txt,"ACTIVE",iff(v=0,"YES":"NO"))
    return IUP_CONTINUE
end function
 
function valuechanged_cb(Ihandle /!*ih*!/)
    return activate(IupGetInt(txt,"VALUE"))
end function
 
function inc_cb(Ihandle /!*ih*!/)
    return activate(IupGetInt(txt,"VALUE")+1)
end function
 
function dec_cb(Ihandle /!*ih*!/)
    return activate(IupGetInt(txt,"VALUE")-1)
end function
 
function esc_close(Ihandle /!*ih*!/, atom c)
    return iff(c=K_ESC?IUP_CLOSE:IUP_CONTINUE)
end function
 
IupOpen()
txt = IupText("VALUECHANGED_CB",Icallback("valuechanged_cb"),"FILTER=NUMBER, EXPAND=YES")
inc = IupButton("increment",Icallback("inc_cb"))
dec = IupButton("decrement",Icallback("dec_cb"),"ACTIVE=NO")
hbx = IupHbox({inc,dec},"MARGIN=0x10, GAP=20")
vbx = IupVbox({txt,hbx},"MARGIN=40x20")
dlg = IupDialog(vbx)
IupSetCallback(dlg, "K_ANY", Icallback("esc_close"))
IupShow(dlg)
IupMainLoop()
*/
--https://rosettacode.org/wiki/Hello_world/Graphical#Phix
--js:
--/*
 alert("Goodbye, World!"); // no title, better off using our own??
--*/
/*
include pGUI.e
IupOpen()
IupMessage("Bye","Goodbye, World!")
IupClose()
*/
--https://rosettacode.org/wiki/Simple_windowed_application#Phix (no js entry)
--/*
include pGUI.e
 
Ihandle dlg, lbl, btn, vbox
integer clicks = 0
 
function click_cb(Ihandle /!*btn*!/)
    clicks += 1
    IupSetStrAttribute(lbl,"TITLE","clicked %d times",{clicks})
    return IUP_DEFAULT;
end function
 
IupOpen()
lbl = IupLabel("There have been no clicks yet")
btn = IupButton("Click me", Icallback("click_cb"))
vbox = IupVbox({lbl, IupHbox({IupFill(),btn,IupFill()})})
dlg = IupDialog(vbox,"MARGIN=10x10, GAP=10, RASTERSIZE=400x0")
IupSetAttribute(dlg, "TITLE", "Simple windowed application")
IupCloseOnEscape(dlg)
IupShow(dlg)
IupMainLoop()
IupClose()
--*/
--https://rosettacode.org/wiki/User_input/Graphical#Phix
--js:
--/*
let str = prompt("Enter a string");
let value = 0;
while (value != 75000) {
    value = parseInt( prompt("Enter the number 75000") );
}
--*/
--/*
-- demo\rosetta\User_Input_Graphical.exw
include pGUI.e
 
Ihandle dlg, label1, input1, label2, input2, OK, Cancel
 
function ok_cb(Ihandle self)
    if self=OK then
        string in1 = IupGetAttribute(input1,"VALUE")
        integer in2 = IupGetInt(input2,"VALUE")
        string msg = sprintf("\"%s\" and %d",{in1,in2})
        IupMessage("You entered",msg)
        -- (return IUP_CONTINUE if unhappy with input)
    end if
    return IUP_CLOSE
end function
 
IupOpen()
label1 = IupLabel("Please enter a string")
input1 = IupText("VALUE=\"a string\", EXPAND=HORIZONTAL")
label2 = IupLabel("and the number 75000")
input2 = IupText("VALUE=75000, EXPAND=HORIZONTAL")
IupSetAttribute(input2,"MASK",IUP_MASK_INT)
OK     = IupButton("OK", "ACTION", Icallback("ok_cb"))
Cancel = IupButton("Cancel", "ACTION", Icallback("ok_cb"))
dlg = IupDialog(IupVbox({IupHbox({label1,input1},"ALIGNMENT=ACENTER, PADDING=5"),
                         IupHbox({label2,input2},"ALIGNMENT=ACENTER, PADDING=5"),
                         IupHbox({IupFill(),OK,Cancel,IupFill()},"PADDING=15")},
                        "GAP=5,MARGIN=5x5"))
IupSetAttribute(dlg,"TITLE","User Input/Graphical")
IupCloseOnEscape(dlg)
IupDestroy(IupNormalizer({OK,Cancel},"NORMALIZE=BOTH"))
IupShow(dlg)
IupMainLoop()
IupClose()
--*/
--https://rosettacode.org/wiki/Window_creation#Phix (no usable js entry)
-- demo\rosetta\Window_creation.exw
--/*
include pGUI.e
 
IupOpen()
Ihandle dlg = IupDialog(IupVbox({IupLabel("hello")},"MARGIN=200x200"))
IupSetAttribute(dlg,"TITLE","Hello")
IupCloseOnEscape(dlg)
IupShow(dlg)
IupMainLoop()
IupClose()
--*/
--https://rosettacode.org/wiki/Window_management#Phix (no js entry)
--hmm? (no need to sweat this one...)
--/*
-- demo\rosetta\Window_management.exw
include pGUI.e
 
Ihandle dlg
 
function doFull(Ihandle /!*ih*!/)
    IupSetAttribute(dlg,"FULLSCREEN","YES")
    return IUP_DEFAULT
end function
 
function doMax(Ihandle /!*ih*!/)
    IupSetAttribute(dlg,"PLACEMENT","MAXIMIZED")
    -- this is a work-around to get the dialog minimised (on win platform)
    IupSetAttribute(dlg,"VISIBLE","YES")
    return IUP_DEFAULT
end function
 
function doMin(Ihandle /!*ih*!/)
    IupSetAttribute(dlg,"PLACEMENT","MINIMIZED")
    -- this is a work-around to get the dialog minimised (on win platform)
    IupSetAttribute(dlg,"VISIBLE","YES")
    return IUP_DEFAULT
end function
 
function doRestore(Ihandle /!*ih*!/)
    IupSetAttribute(dlg,"OPACITY","255")
    IupSetAttribute(dlg,"FULLSCREEN","NO")
    IupSetAttribute(dlg,"PLACEMENT","NORMAL")
    IupSetAttribute(dlg,"VISIBLE","YES")
    return IUP_DEFAULT
end function
 
function doDim(Ihandle /!*ih*!/)
    IupSetAttribute(dlg,"OPACITY","60")
    return IUP_DEFAULT
end function
 
function doShow(Ihandle /!*ih*!/)
    IupSetAttribute(dlg,"OPACITY","255")
    return IUP_DEFAULT
end function
 
function doMove(Ihandle /!*ih*!/)
    integer {x,y} = IupGetIntInt(dlg,"SCREENPOSITION")
    integer shift = iff(IupGetInt(NULL,"SHIFTKEY")?-10,+10)
    IupShowXY(dlg,x+shift,y+shift)
    return IUP_DEFAULT
end function
 
procedure main()
    IupOpen()
 
    Ihandle hbox = IupHbox({IupButton("restore",    Icallback("doRestore")),
                            IupButton("full screen",Icallback("doFull")),
                            IupButton("maximize",   Icallback("doMax")),
                            IupButton("minimize",   Icallback("doMin")),
                            IupButton("dim",        Icallback("doDim")),
                            IupButton("show",       Icallback("doShow")),
                            IupButton("move",       Icallback("doMove"))})
    IupSetAttribute(hbox,"MARGIN", "10x10")
    IupSetAttribute(hbox,"PADDING", "5x5")
 
    dlg = IupDialog(hbox)
    IupSetAttribute(dlg,"OPACITY","255")
    IupCloseOnEscape(dlg)
 
    IupShowXY(dlg,IUP_CENTER,IUP_CENTER)
    IupMainLoop()
    IupClose()
end procedure
main()
--*/
--C:\Program Files (x86)\Phix\demo\pGUI\list[2/3/view].exw
--C:\Program Files (x86)\Phix\demo\pGUI\matrix[3].exw
--C:\Program Files (x86)\Phix\demo\pGUI\PhixLogo.exw
--C:\Program Files (x86)\Phix\demo\pGUI\sample.exw  [one bit at a time!]
--C:\Program Files (x86)\Phix\demo\pGUI\tree.exw    [or ""]
-- plus, the 7guis... (Counter, Converter, Booker, Timer, CRUD, CircleDraw, Cells, in that order)
--That's all folks!

-- things you'll miss:
--  binary/octal/general numbers bases in 0bNN, 0oNN, 0tNN, o(2..36)NN formats.

-- v0:
--/*
function quit_cb(Ihandle /!*self*!/)
    return IUP_CLOSE
end function

IupOpen()
Ihandle quit_bt = IupButton("Quit", "ACTION", Icallback("quit_cb")),
        label = IupLabel("Hello World","EXPAND=YES, ALIGNMENT=ACENTER:ACENTER"),
        vbox = IupVbox({label, quit_bt},"ALIGNMENT=ACENTER,MARGIN=10x10,GAP=15"),
        dlg = IupDialog(vbox,`TITLE="Dialog Title", SIZE=180x`)
IupSetAttributeHandle(dlg, "DEFAULTESC", quit_bt)
--*/
--?IupGetAttribute(dlg,"RASTERSIZE")
--IupSetAttribute(dlg,"RASTERSIZE",NULL)

/*
Searching for: GUI
 Files scanned 3980, Directories scanned 93, Lines 4688482
C:\Program Files (x86)\Phix\demo\rosetta\2048.exw:6 --  ported to pGUI July 2017
C:\Program Files (x86)\Phix\demo\rosetta\2048.exw:8 --  Faithful desktop gui (windows only) reproduction of https://gabrielecirulli.github.io/2048/
C:\Program Files (x86)\Phix\demo\rosetta\2048.exw:11 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\9billionnames.exw:76 include pGUI.e [IupPlot]
C:\Program Files (x86)\Phix\demo\rosetta\Abelian_sandpile_model.exw:23 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\animate_pendulum.exw:7 -- This has now been ported to pGUI, see animate_pendulum2.exw
C:\Program Files (x86)\Phix\demo\rosetta\animate_pendulum2.exw:7 -- Port of animate_pendulum.exw from arwen to pGUI
C:\Program Files (x86)\Phix\demo\rosetta\animate_pendulum2.exw:17 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Animation.exw:7 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Archimedean_spiral.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Audio_frequency_generator.exw:4 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\BarnsleyFern.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Bilinear_interpolation.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Black_Box.exw:5 --  A configurable GUI version of the Black Box game, with a Knuth solver/helper.
C:\Program Files (x86)\Phix\demo\rosetta\Black_Box.exw:466 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\BrownianTree.exw:6 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Chaos_game.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Clock.exw:5 include pGUI.e
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Draw_a_clock.raw:3564 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Color_quantization.exw:12 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Colour_bars.exw:9 include pGUI.e
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Colour_bars\Display.raw:1146 {{libheader|pGUI}}
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Colour_bars\Display.raw:1150 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Colour_pinstripe.exw:9 include pGUI.e
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Colour_pinstripe\Display.raw:810 {{libheader|pGUI}}
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Colour_pinstripe\Display.raw:815 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Colour_wheel.exw:10 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Compare_sorting_algorithms.exw:15 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Conways_Game_of_Life.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Count_examples.exw:240 GUI_component_interaction 44
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Curve_that_touches_three_points.raw:294 <lang Phix>include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\DeathStar.exw:7 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Determine_if_two_triangles_overlap.raw:3124 {{libheader|pGUI}}
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Determine_if_two_triangles_overlap.raw:3127 <lang Phix>include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\DragonCurve.exw:7 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\DrawRotatingCube.exw:8 include pGUI.e
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Draw_a_rotating_cube.raw:994 {{libheader|pGUI}}
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Draw_a_rotating_cube.raw:998 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Draw_a_sphere.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\draw_cuboid.exw:7 --  Ported to pGUI August 2017
C:\Program Files (x86)\Phix\demo\rosetta\draw_cuboid.exw:20 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Extensible_prime_generator.exw:13 --  I investigated the use of so-called "wheels", beguiled by the claim that "a 2-3-5-7 
C:\Program Files (x86)\Phix\demo\rosetta\FibonacciFractal.exw:5 include pGUI.e
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Fibonacci_word\fractal.raw:1395 {{libheader|pGUI}}
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Fibonacci_word\fractal.raw:1399 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Forest_fire.exw:10 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Four.exw:75 --  extended off-page version with a full GUI AST browser and other debug tooling).
C:\Program Files (x86)\Phix\demo\rosetta\FractalTree.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Gallery_Generator.exw:4 --DEV incomplete (port to pGUI in progress, will not yet compile)
C:\Program Files (x86)\Phix\demo\rosetta\Gallery_Generator.exw:203 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\GaltonBox.exw:9 include pGUI.e
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Galton_box_animation.raw:2571 {{libheader|pGUI}}
C:\Program Files (x86)\Phix\demo\rosetta\Greyscale_bars.exw:10 include pGUI.e
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Greyscale_bars\Display.raw:1188 {{libheader|pGUI}}
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Greyscale_bars\Display.raw:1192 include pGUI.e
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\GUI_component_interaction.raw:2371 {{libheader|pGUI}}
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\GUI_component_interaction.raw:2372 <lang Phix>include pGUI.e
--^ see above, https://rosettacode.org/wiki/GUI_component_interaction#Phix (no js entry)
C:\Program Files (x86)\Phix\demo\rosetta\hexapawn.exw:18 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\hexapawn.exw:233 -- === ott gui version ===
C:\Program Files (x86)\Phix\demo\rosetta\hilbert_curve.exw:7 include pGUI.e
// needs translating to pGUI:
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Honeycombs.raw:1 {{task}}[[CategoryGUI]]
C:\Program Files (x86)\Phix\demo\rosetta\Hough_transform.exw:9 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\ImageNoise.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Image_convolution.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Julia_set.exw:5 -- Interactive gui (zoom/pan incomplete).
C:\Program Files (x86)\Phix\demo\rosetta\Julia_set.exw:7 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Keyboard_macros.raw:546 {{libheader|pGUI}}
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Keyboard_macros.raw:550 <lang Phix>include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Koch_curve.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\K_means_clustering.exw:8 --  the GUI code, or modifying it to produce an n-dimensional representation. Obviously 
C:\Program Files (x86)\Phix\demo\rosetta\K_means_clustering.exw:15 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\mastermind.exw:52 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Matrix_Digital_Rain.exw:10 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Morpion_solitaire.exw:5 --  I focused on a half-decent gui and playing back the 178-record.
C:\Program Files (x86)\Phix\demo\rosetta\Morpion_solitaire.exw:67 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Morpion_solitaire.exw:107 -- (It turned out pretty easy to map that to a fairly nice gui, plus of course
C:\Program Files (x86)\Phix\demo\rosetta\Mouse_position.exw:11 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Munching_squares.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\OpenGL.raw:1971 {{libheader|pGUI}}
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\OpenGL.raw:1972 <lang Phix>include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\OpenGLShader.exw:5 --[DEV incomplete - ah, this is a copy of demo\pGUI\triangle.exw for https://rosettacode.org/wiki/OpenGL#Phix but
C:\Program Files (x86)\Phix\demo\rosetta\OpenGLShader.exw:11 --  Converted to pGUI by Pete Lomax
C:\Program Files (x86)\Phix\demo\rosetta\OpenGLShader.exw:14 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\OpenGLShader.exw:15 include ..\pGUI\opengl.e
C:\Program Files (x86)\Phix\demo\rosetta\peano_curve.exw:7 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Penrose_tiling.exw:9 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Pentagram.exw:9 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Perceptron.exw:12 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\plasma.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Playing_cards.exw:5 -- Includes both ascii (for a console) and unicode (for a gui) displays
C:\Program Files (x86)\Phix\demo\rosetta\Playing_cards.exw:38 --GUI:
C:\Program Files (x86)\Phix\demo\rosetta\Playing_cards.exw:52 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Playing_cards.exw:56 procedure gui_show()
C:\Program Files (x86)\Phix\demo\rosetta\Playing_cards.exw:81 gui_show()
C:\Program Files (x86)\Phix\demo\rosetta\Plot_coordinate_pairs.exw:7 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Polynomial_regression.raw:1534 {{libheader|pGUI}}
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Polynomial_regression.raw:1535 <lang Phix>include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Polyspiral.exw:10 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\PythagorasTree.exw:7 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Raster_bars.exw:8 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\SHA.ASM:57  format PE GUI 4.0 DLL
C:\Program Files (x86)\Phix\demo\rosetta\Sierpinski_arrowhead_curve.exw:9 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Sierpinski_curve.exw:9 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Sierpinski_square_curve.exw:57 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\SierpinskyPentagon.exw:6 --  1 standard pGUI drawing
C:\Program Files (x86)\Phix\demo\rosetta\SierpinskyPentagon.exw:29 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\SierpinskyPentagon.exw:523 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\SierpinskyTriangle.exw:5 include pGUI.e
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Sierpinski_triangle\Graphical.raw:1537 {{libheader|pGUI}}
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Sierpinski_triangle\Graphical.raw:1541 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Simple_window.exw:4 include pGUI.e
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Simple_windowed_application.raw:1983 {{libheader|pGUI}}
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Simple_windowed_application.raw:1984 <lang Phix>include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Single_instance.exw:6 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Speech.exw:7 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Sunflower.exw:7 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Superellipse.exw:9 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Sutherland_Hodgman_polygon_clipping.exw:53 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Tetrominoes.exw:21 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\User_Input_Graphical.exw:4 include pGUI.e
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\User_input\Graphical.raw:1109 {{libheader|pGUI}}
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\User_input\Graphical.raw:1113 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\vibrect.exw:12 include pGUI.e
--C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Vibrating_rectangles.raw:717 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\VoronoiDiagram.exw:8 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Window_creation.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Window_management.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Wireworld.exw:92 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\XiaolinWuLine.exw:7 --  For education/comparision purposes only see demo\pGUI\aaline.exw
C:\Program Files (x86)\Phix\demo\rosetta\XiaolinWuLine.exw:16 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\Yin_and_yang.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\7guis\Booker.exw:2 -- demo\rosetta\7guis\Booker.exw
C:\Program Files (x86)\Phix\demo\rosetta\7guis\Booker.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\7guis\Cells.exw:2 -- demo\rosetta\7guis\Cells.exw
C:\Program Files (x86)\Phix\demo\rosetta\7guis\Cells.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\7guis\CircleDraw.exw:2 -- demo\rosetta\7guis\CircleDraw.exw
C:\Program Files (x86)\Phix\demo\rosetta\7guis\CircleDraw.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\7guis\Converter.exw:2 -- demo\rosetta\7guis\Converter.exw
C:\Program Files (x86)\Phix\demo\rosetta\7guis\Converter.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\7guis\Counter.exw:2 -- demo\rosetta\7guis\Counter.exw
C:\Program Files (x86)\Phix\demo\rosetta\7guis\Counter.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\7guis\CRUD.exw:2 -- demo\rosetta\7guis\CRUD.exw
C:\Program Files (x86)\Phix\demo\rosetta\7guis\CRUD.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\7guis\CRUD.exw:145 -- Notes GAP/MARGIN/PADDING etc obtained using the incomplete pGUI-IDE;
C:\Program Files (x86)\Phix\demo\rosetta\7guis\Timer.exw:2 -- demo\rosetta\7guis\Timer.exw
C:\Program Files (x86)\Phix\demo\rosetta\7guis\Timer.exw:5 include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\7guis\Timer.exw:71 --        been retained to match the specs of 7GUIs.

C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\GUI\Maximum_window_dimensions.raw:738 {{libheader|pGUI}}
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\GUI\Maximum_window_dimensions.raw:739 <lang Phix>include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\GUI_enabling\disabling_of_controls.raw:2004 {{libheader|pGUI}}
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\GUI_enabling\disabling_of_controls.raw:2005 <lang Phix>include pGUI.e
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Hello_world\Graphical.raw:2510 {{libheader|pGUI}}
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Hello_world\Graphical.raw:2511 <lang Phix>include pGUI.e
*/
--/*
//SVG Icons - svgicons.sparkk.fr
.svg-icon {
  width: 1em;
  height: 1em;
}
.svg-icon path,
.svg-icon polygon,
.svg-icon rect {
  fill: #4691f6;
}
.svg-icon circle {
  stroke: #4691f6;
  stroke-width: 1;
}
closed folder:
<svg class="svg-icon" viewBox="0 0 20 20">
 <path d="M17.927,5.828h-4.41l-1.929-1.961
 c-0.078-0.079-0.186-0.125-0.297-0.125
 H4.159c-0.229,0-0.417,0.188-0.417,0.417
 v1.669H2.073c-0.229,0-0.417,0.188-0.417,0.417
 v9.596c0,0.229,0.188,0.417,0.417,0.417
 h15.854c0.229,0,0.417-0.188,0.417-0.417
 V6.245C18.344,6.016,18.156,5.828,17.927,5.828 
 M4.577,4.577h6.539l1.231,1.251h-7.77V4.577z 
 M17.51,15.424H2.491V6.663H17.51V15.424z"></path>
</svg>
open folder:
<svg class="svg-icon" viewBox="0 0 20 20">
    <path fill="none" d="M19.521,7.267c-0.144-0.204-0.38-0.328-0.631-0.328h-3.582l-0.272-1.826c-0.055-0.379-0.379-0.656-0.76-0.656
    H9.802l-0.39-0.891c-0.123-0.279-0.399-0.46-0.704-0.46H1.11c-0.222,0-0.434,0.096-0.58,0.264C0.385,3.537,0.319,3.76,0.349,3.981
    l1.673,12.243c0,0,0,0,0,0.002v0.004c0.015,0.113,0.06,0.213,0.119,0.303c0.006,0.009,0.006,0.023,0.012,0.033
    c0.012,0.016,0.033,0.024,0.046,0.04c0.054,0.065,0.114,0.118,0.185,0.161c0.027,0.018,0.051,0.035,0.078,0.048
    c0.099,0.045,0.206,0.078,0.32,0.078h0.002l0,0h13.03c0.323,0,0.611-0.201,0.722-0.505l3.076-8.416
    C19.698,7.735,19.663,7.474,19.521,7.267z M8.203,4.644l0.391,0.889c0.123,0.279,0.399,0.461,0.704,0.461h4.315l0.141,0.944H5.859
    c-0.323,0-0.611,0.201-0.723,0.505l-2.011,5.505L1.992,4.644H8.203z M15.276,15.356H3.882l2.515-6.879H17.79L15.276,15.356z"></path>
</svg>
--*/

/*
const solution = (arr) => {
    let l = arr.length;
    function sumt(i) {
        let c = (i+1)*2, res = 0;
        if (i<l && arr[i]!=-1) { res = arr[i]+sumt(c-1)+sumt(c); }
        return res;
    }
    let left = sumt(1), right = sumt(2);
    console.log("left:"+left);
    console.log("right:"+right);
    if (left>right) { return "Left"; }
    if (left<right) { return "Right"; }
    return "";
}
console.log(solution([1, 4, 100, 5]));

const solution = (arr) => {
    // assume tree follows the pattern LRLLRRLLLLRRRR...
    // step goes 1,2,4..., stage is within that.
    // use counts[idx] for left,right.
    let l = arr.length, counts = [0,0], idx = 0, step = 1, stage = 1;
    for (let i = 1; i < l; i += 1) {
        let ai = arr[i];
        if (ai!=-1) { counts[idx] += ai; }
        stage += 1;
        if (stage>step) {
            if (idx==1) { step *= 2; }
            idx = 1 - idx;
            stage = 1;
        }
    }
    let [left,right] = counts;
    if (left>right) { return "Left"; }
    if (left<right) { return "Right"; }
    return "";
}
//  console.log("left:"+left);
//  console.log("right:"+right);
//console.log(solution([1, 4, 100, 5]));
console.log(solution([1, 10, 5, 1, 0, 6]));

untested:
const solution = (arr) => {
    // assume tree follows the pattern LRLLRRLLLLRRRR...
    // step goes 1,2,4..., stage is within that.
    const LEFT = 0, RIGHT = 1;
    let l = arr.length, left = 0, right = 0, 
        side = LEFT, step = 1, stage = 1;
    for (let i = 1; i < l; i += 1) {
        let ai = arr[i];
        if (ai!=-1) {
            if (side==LEFT) {
                left += ai;
            } else {
                right += ai;
            }
        }
        stage += 1;
        if (stage>step) {
            if (side==RIGHT) { step *= 2; }
            side = 1 - side;
            stage = 1;
        }
    }
    if (left>right) { return "Left"; }
    if (left<right) { return "Right"; }
    return "";
}

Searching for: @=
 Files scanned 1195, Directories scanned 88, Lines 1224474
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Barnsley_fern.htm:342 <pre class="text highlighted_source">--<br />-- demo\rosetta\BarnsleyFern.exw<br />--<br />include pGUI.e<br />&#160;<br />Ihandle d
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Color_wheel.htm:211 <pre class="text highlighted_source">-- demo\rosetta\Colour_wheel.exw<br />include pGUI.e<br />&#160;<br />Ihandle dlg, canvas<br />
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Conway%27s_Game_of_Life.htm:2189 <pre class="text highlighted_source">--<br />-- demo\rosetta\Conways_Game_of_Life.exw<br />--<br />include pGUI.e<br />&#160;<br />I
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\K-means%2B%2B_clustering.htm:361 <pre class="text highlighted_source">-- demo\rosetta\K_means_clustering.exw<br />--  Press F5 to restart<br />include pGUI.e<br />&#
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Matrix_chain_multiplication.htm:338 <pre class="text highlighted_source">function optimal_chain_order(int i, int j, sequence s)<br />    if i==j then<br />        retur
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Mind_boggling_card_trick.htm:447 <pre class="text highlighted_source">constant n = 52,<br />         pack = shuffle(repeat('r',n/2)&amp;repeat('b',n/2))<br />&#160;<
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\N-body_problem.htm:2178 <pre class="text highlighted_source">sequence origin = {0,0,0}<br />&#160;<br />constant nbody = &quot;&quot;&quot;<br />0.01 3 20<b
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\P-value_correction.htm:1036 <pre class="text highlighted_source">enum UP, DOWN<br />&#160;<br />function ratchet(sequence p, integer direction)<br />    atom m 
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Paraffins.htm:1175 <pre class="text highlighted_source">constant MAX_N = 32,<br />         BRANCH = 4<br />&#160;<br />sequence {rooted,unrooted} @= re
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Polynomial_regression.htm:597 <pre class="text highlighted_source">constant x = {0,1,2,3,4,5,6,7,8,9,10}<br />constant y = {1,6,17,34,57,86,121,162,209,262,321}<b
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Ramsey%27s_theorem.htm:453 <pre class="text highlighted_source">sequence a = repeat(repeat('0',17),17),<br />         idx = repeat(0,4)<br />&#160;<br />functi
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Strong_and_weak_primes.htm:391 <pre class="text highlighted_source">while sieved&lt;10_000_000 do add_block() end while<br />sequence {strong, weak} @= {}<br />for
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Thiele%27s_interpolation_formula.htm:1472 <pre class="text highlighted_source">constant N = 32,<br />         N2 = (N * (N - 1) / 2),<br />         STEP = 0.05<br />&#160;<br
C:\Program Files (x86)\Phix\demo\rosetta\rc_cache\Tic-tac-toe.htm:1759 <pre class="text highlighted_source">sequence board = repeat(' ',9)  -- {' '/'X'/'O'}<br />&#160;<br />constant wins = {{1,2,3},{4,5
*/
